<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Quiz - Mobile & Desktop</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.0/dist/umd/supabase.js"></script>
    <script src="components/scoring-system.js"></script>
    <style>
        /* MOBILE-FIRST RESET - NO SPACING ISSUES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: auto;
            min-height: auto;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: white;
            overflow-x: hidden;
        }


        /* MOBILE CONTAINER - TIGHT SPACING */
        .mobile-container {
            width: 100%;
            padding: 8px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* MOBILE PROFILE BAR */
        .mobile-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 8px 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-weight: 600;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 2px;
        }

        .profile-status {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* QUESTION CARD - MINIMAL SPACING */
        .question-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
        }

        .question-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.3;
        }

        /* OPTIONS */
        .option-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option-card:hover, .option-card.selected {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.1);
        }

        .option-icon {
            font-size: 20px;
            min-width: 24px;
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-weight: 600;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 2px;
        }

        .option-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* CHECKBOXES */
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover, .checkbox-item.selected {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.1);
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        /* FORM INPUTS */
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 16px;
            color: white;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        /* PROGRESSIVE FORM SECTIONS */
        #businessNameSection,
        #businessTypeSection, 
        #cityLocationSection {
            display: none;
        }
        
        /* NEXT FIELD INDICATOR */
        .next-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            align-items: center;
            justify-content: center;
            margin: 16px auto;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: scale(0.8);
        }
        
        .next-indicator.show {
            display: flex;
            transform: scale(1);
        }
        
        .next-indicator:hover {
            transform: scale(1.1);
        }
        
        .next-indicator svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(255, 255, 255, 0.08);
        }

        /* BUTTON */
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: transform 0.2s ease;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        /* SCREEN MANAGEMENT */
        .screen {
            display: none;
            width: 100%;
            height: auto;
            padding: 0;
            margin: 0;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* CHAT MESSAGE */
        .chat-message {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
        }

        /* PROGRESS BAR */
        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            height: 6px;
            margin: 0 8px 16px 8px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* RESULTS STYLES */
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .score-number {
            font-size: 48px;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* TOPIKO BRAND */
        .topiko-text {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* NAVIGATION BUTTONS */
        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .nav-buttons .btn {
            margin-top: 0;
        }


        /* PROFESSIONAL AUDIT STYLES */
        .audit-progress {
            background: rgba(255, 255, 255, 0.1);
            height: 4px;
            border-radius: 2px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .audit-progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #f093fb 100%);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .audit-question-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .audit-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .audit-question-number {
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .audit-category {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .audit-question-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .audit-explanation {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.85);
        }

        .audit-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .audit-option {
            flex: 1;
            min-width: 120px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }

        .audit-option:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .audit-option:hover:before {
            left: 100%;
        }

        .audit-option:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .audit-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .audit-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .audit-nav-info {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }

        .audit-next-btn {
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .audit-next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .audit-next-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* DETAILED PLAN STYLES */
        .plan-container {
            max-height: 60vh;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 16px;
        }

        .plan-container::-webkit-scrollbar {
            width: 6px;
        }

        .plan-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .plan-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            border-radius: 3px;
        }

        .plan-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .plan-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        #screen5 .plan-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding: 16px 0;
            justify-content: center;
            align-items: center;
        }
        
        /* Hide plan-actions on all other screens - STRONG OVERRIDE */
        .screen:not(#screen5) .plan-actions,
        .plan-actions:not(#screen5 .plan-actions) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Ensure buttons only show on screen6 - AGGRESSIVE FIX */
        .plan-btn {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        #screen5.active .plan-btn {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            left: auto !important;
        }
        
        /* Hide screen6 content completely unless screen6 is active */
        #screen5:not(.active) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* Hide screen6 chat message and content on all other screens */
        #chatMessage4, #detailedPlanContent, #screen5 .plan-container {
            display: none !important;
            visibility: hidden !important;
        }
        
        #screen5.active #chatMessage4, 
        #screen5.active #detailedPlanContent, 
        #screen5.active .plan-container {
            display: block !important;
            visibility: visible !important;
        }

        .plan-btn {
            flex: 0 0 auto;
            width: 140px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-align: center;
        }

        .plan-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .plan-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .plan-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .plan-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        /* MOBILE RESPONSIVENESS FOR AUDIT */
        @media (max-width: 480px) {
            .audit-options {
                flex-direction: column;
            }
            
            .audit-option {
                min-width: 100%;
            }
            
            #screen5 .plan-actions {
                flex-direction: column;
            }
            
            .audit-question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        /* PROGRESSIVE INSIGHTS STYLES */
        .insight-container {
            margin-top: 20px;
            animation: slideInUp 0.5s ease-out;
        }

        .insight-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(240, 147, 251, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-icon {
            font-size: 24px;
            min-width: 32px;
            text-align: center;
        }

        .insight-text {
            font-size: 14px;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.9);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* SOCIAL PROOF STYLES */
        .social-proof {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 14px;
            border-radius: 16px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
            animation: fadeInOut 4s ease-in-out infinite;
            z-index: 1000;
            max-width: 250px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        /* Responsive social proof */
        @media (max-width: 480px) {
            .social-proof {
                top: 70px;
                right: 15px;
                left: 15px;
                max-width: none;
                font-size: 10px;
                padding: 6px 12px;
                text-align: center;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .social-proof {
                top: 75px;
                right: 20px;
                max-width: 220px;
                font-size: 10px;
                padding: 7px 12px;
            }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(10px); }
            25%, 75% { opacity: 1; transform: translateY(0); }
        }

        /* LANDING PAGE STYLES */
        .landing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }

        .landing-logo {
            margin-bottom: 36px;
        }

        .landing-title {
            font-size: 28px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .landing-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 36px;
            line-height: 1.4;
        }

        .landing-benefits {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 14px;
            margin-bottom: 44px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .benefit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 18px 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .benefit-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .benefit-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .benefit-icon {
            font-size: 20px;
            margin-bottom: 8px;
            color: #4CAF50;
        }

        .benefit-text {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 600;
            line-height: 1.3;
        }

        .landing-start-btn {
            width: 100%;
            max-width: 280px;
            padding: 18px 32px;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .landing-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .landing-urgency {
            margin-top: 24px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            text-align: center;
        }

        .landing-small-print {
            margin-top: 16px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            line-height: 1.4;
        }

        /* Testimonials Section */
        .testimonials-section {
            margin-top: 16px;
            padding: 20px 0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin-bottom: 20px;
        }

        .testimonial {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .testimonial-text {
            font-size: 14px;
            font-style: italic;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
        }

        .testimonial-author {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }

        .stars {
            color: #ffc107;
            font-size: 14px;
        }

        /* OTP Screen Styles */
        .question-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 24px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
        }

        .phone-input-container {
            display: flex;
            gap: 8px;
        }

        .country-code {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px;
            color: white;
            font-size: 14px;
            width: 90px;
            backdrop-filter: blur(10px);
        }

        .phone-input {
            flex: 1;
        }

        .otp-input {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 4px;
        }

        .otp-timer {
            text-align: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin: 12px 0;
        }

        #countdown {
            font-weight: 600;
            color: #667eea;
        }




        /* Hide desktop elements on mobile/tablet */
        @media (max-width: 767px) {
            .desktop-progress,
            .desktop-ambient-left,
            .desktop-ambient-right,
            .desktop-trust-badges {
                display: none !important;
            }
        }

        /* DESKTOP RESPONSIVE DESIGN */
        @media (min-width: 768px) {
            body {
                background: #1a1a2e;
                position: relative;
                overflow-x: hidden;
            }

            /* Clean background - no effects */

            /* Desktop container wrapper */
            .desktop-wrapper {
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
                padding: 20px;
                position: relative;
                z-index: 1;
            }

            /* Center the mobile container */
            .mobile-container {
                max-width: 420px;
                width: 100%;
                padding: 20px;
                position: relative;
                z-index: 2;
            }

            /* Desktop progress indicator - Auto show on desktop */
            .desktop-progress {
                position: fixed;
                top: 30px;
                left: 30px;
                right: 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(20px);
                border-radius: 50px;
                padding: 12px 24px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                z-index: 100;
            }

            .desktop-logo {
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 600;
                font-size: 18px;
                color: white;
            }

            .desktop-logo img {
                width: 32px;
                height: 32px;
                border-radius: 8px;
            }

            .desktop-progress-bar {
                flex: 1;
                max-width: 300px;
                margin: 0 30px;
                height: 8px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 4px;
                overflow: hidden;
            }

            .desktop-progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #667eea 0%, #f093fb 100%);
                border-radius: 4px;
                transition: width 0.3s ease;
                width: 0%;
            }

            .desktop-progress-text {
                font-size: 14px;
                color: rgba(255, 255, 255, 0.8);
                font-weight: 500;
            }

            /* Side ambient elements */
            .desktop-ambient-left,
            .desktop-ambient-right {
                position: fixed;
                top: 50%;
                transform: translateY(-50%);
                width: 200px;
                z-index: 1;
            }

            .desktop-ambient-left {
                left: 30px;
            }

            .desktop-ambient-right {
                right: 30px;
            }

            /* Trust badges - Auto show on desktop */
            .desktop-trust-badges {
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 20px;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(20px);
                border-radius: 50px;
                padding: 12px 24px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                z-index: 100;
            }

            .trust-badge {
                display: flex;
                align-items: center;
                gap: 8px;
                color: rgba(255, 255, 255, 0.8);
                font-size: 12px;
            }

            .trust-badge-icon {
                font-size: 16px;
            }

            /* Social proof side panel */
            .desktop-social-proof {
                background: rgba(255, 255, 255, 0.05);
                backdrop-filter: blur(20px);
                border-radius: 16px;
                padding: 20px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                margin-bottom: 20px;
            }

            .social-proof-title {
                font-size: 14px;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.9);
                margin-bottom: 12px;
                text-align: center;
            }

            .social-stat {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
                font-size: 12px;
                color: rgba(255, 255, 255, 0.7);
            }

            .social-stat-number {
                font-weight: 600;
                color: #667eea;
            }

            /* Floating particles animation */
            .desktop-particle {
                position: absolute;
                width: 4px;
                height: 4px;
                background: rgba(102, 126, 234, 0.6);
                border-radius: 50%;
                animation: float 8s infinite linear;
            }

            @keyframes float {
                0% {
                    transform: translateY(100vh) rotate(0deg);
                    opacity: 0;
                }
                10% {
                    opacity: 1;
                }
                90% {
                    opacity: 1;
                }
                100% {
                    transform: translateY(-100px) rotate(360deg);
                    opacity: 0;
                }
            }

            @keyframes pulse {
                0% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
                }
                70% {
                    transform: scale(1.05);
                    box-shadow: 0 0 0 10px rgba(251, 191, 36, 0);
                }
                100% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
                }
            }

            /* Enhanced mobile profile for desktop */
            .mobile-profile {
                margin-top: 60px; /* Account for desktop header */
            }
        }

        /* New Results Page Styles */
        .results-container {
            padding: 20px;
            gap: 24px;
            display: flex;
            flex-direction: column;
        }

        .recommendation-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }

        .primary-card {
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-icon {
            font-size: 24px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 0.5px;
        }

        .product-name {
            font-size: 22px;
            font-weight: 700;
            color: white;
            margin-bottom: 16px;
        }

        .product-divider {
            height: 1px;
            background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.3) 100%);
            margin-bottom: 20px;
        }

        .features-list {
            margin-bottom: 20px;
        }

        .feature-item {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .pricing {
            font-size: 20px;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 20px;
            text-align: center;
        }

        .consultation-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .consultation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .consultation-btn.secondary {
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            font-size: 14px;
            padding: 12px 20px;
        }

        .marketing-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #fbbf24 50%, transparent 100%);
            margin-bottom: 20px;
            position: relative;
        }

        .marketing-divider::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 2px;
            background: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .marketing-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .marketing-icon {
            font-size: 20px;
        }

        .marketing-title {
            font-size: 16px;
            font-weight: 700;
            color: #fbbf24;
        }

        .marketing-product {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
        }

        .marketing-price {
            font-size: 16px;
            font-weight: 600;
            color: #4ade80;
            margin-bottom: 16px;
        }

        .marketing-features {
            margin-bottom: 16px;
        }

        .marketing-features .feature-item {
            font-size: 13px;
            margin-bottom: 6px;
        }

        .marketing-cta {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-style: italic;
        }

        .bundle-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            margin-bottom: 20px;
        }

        .bundle-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .bundle-icon {
            font-size: 20px;
        }

        .bundle-title {
            font-size: 14px;
            font-weight: 700;
            color: #a78bfa;
            letter-spacing: 0.5px;
        }

        .bundle-content {
            margin-bottom: 16px;
        }

        .consultation-preview {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-top: 8px;
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .preview-icon {
            font-size: 18px;
        }

        .preview-title {
            font-size: 15px;
            font-weight: 600;
            color: white;
        }

        .preview-content {
            margin-bottom: 12px;
        }

        .preview-item {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .preview-footer {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            text-align: center;
        }

        /* Large desktop optimizations */
        @media (min-width: 1200px) {
            .desktop-ambient-left {
                left: 60px;
                width: 250px;
            }

            .desktop-ambient-right {
                right: 60px;
                width: 250px;
            }

            .mobile-container {
                max-width: 450px;
            }
        }

        /* Ultra-wide desktop */
        @media (min-width: 1600px) {
            .desktop-ambient-left {
                left: 120px;
                width: 300px;
            }

            .desktop-ambient-right {
                right: 120px;
                width: 300px;
            }
        }
        
        /* FORCE HIDE DESKTOP ELEMENTS - ALWAYS SHOW MOBILE VIEW */
        .desktop-progress,
        .desktop-ambient-left, 
        .desktop-ambient-right,
        .desktop-trust-badges {
            display: none !important;
        }
        
        /* ENSURE MOBILE CONTAINER IS VISIBLE */
        .mobile-container,
        .desktop-wrapper {
            display: flex !important;
            flex-direction: column !important;
        }
        
        /* ENSURE SCREENS WORK PROPERLY - ONLY ACTIVE SCREEN VISIBLE */
        .screen {
            display: none !important;
        }
        
        .screen.active {
            display: flex !important;
            flex-direction: column !important;
        }
        
        #landingScreen.active {
            display: flex !important;
            flex-direction: column !important;
        }
        
        /* DESKTOP CENTERING - COMPACT LAYOUT */
        @media screen and (min-width: 768px) {
            html, body {
                display: flex !important;
                justify-content: center !important;
                align-items: flex-start !important;
                min-height: 100vh !important;
                max-height: 100vh !important;
                padding: 0 !important;
                margin: 0 !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
                width: 100vw !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
            }
            
            html .mobile-container,
            body .mobile-container,
            .mobile-container {
                max-width: 420px !important;
                width: 420px !important;
                margin: 0 !important;
                flex-shrink: 0 !important;
                position: relative !important;
                min-height: 100vh !important;
                max-height: 100vh !important;
                padding: 20px 16px !important;
                overflow-y: auto !important;
                scrollbar-width: none !important; /* Firefox */
                -ms-overflow-style: none !important; /* IE/Edge */
                box-sizing: border-box !important;
            }
            
            /* Hide scrollbar for Chrome/Safari */
            .mobile-container::-webkit-scrollbar {
                display: none !important;
            }
            
            /* Smooth scrolling within container */
            .mobile-container {
                scroll-behavior: smooth !important;
            }
            
            /* Fix Executive Summary page layout */
            #screen5 {
                display: flex !important;
                flex-direction: column !important;
                height: 100% !important;
            }
            
            #screen5 .plan-container {
                max-height: calc(100vh - 200px) !important;
                flex-grow: 1 !important;
                overflow-y: auto !important;
            }
            
            #screen5 .plan-actions {
                flex-shrink: 0 !important;
                margin-top: 16px !important;
                padding: 16px 0 !important;
                justify-content: center !important;
                align-items: center !important;
            }
            
            /* Reduce screen padding for compact layout */
            .screen {
                padding: 0 !important;
                min-height: auto !important;
            }
            
            /* Override any conflicting styles */
            * {
                max-width: none !important;
            }
            
            .mobile-container * {
                max-width: 100% !important;
            }
        }
        
        /* Schedule Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border-radius: 16px;
            padding: 0;
            width: 90%;
            max-width: 500px;
            color: white;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: rgba(255,255,255,0.6);
        }
        
        .close:hover {
            color: white;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .time-slots {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .time-slot {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .time-slot:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }
        
        .time-slot.selected {
            background: rgba(0,122,255,0.3);
            border-color: #007AFF;
        }
        
        @media (max-width: 768px) {
            .time-slots {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Desktop Progress Header -->
    <div class="desktop-progress">
        <div class="desktop-logo">
            <img src="/logo.png" alt="Topiko">
            Digital Readiness Assessment
        </div>
        <div class="desktop-progress-bar">
            <div class="desktop-progress-fill" id="desktopProgressFill"></div>
        </div>
        <div class="desktop-progress-text" id="desktopProgressText">0% Complete</div>
    </div>

    <!-- Desktop Ambient Left -->
    <div class="desktop-ambient-left">
        <div class="desktop-social-proof">
            <div class="social-proof-title">üéØ Live Assessment Data</div>
            <div class="social-stat">
                <span class="trust-badge-icon">üë•</span>
                <span class="social-stat-number" id="liveUserCount">1,247</span>
                <span>assessments today</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">‚≠ê</span>
                <span class="social-stat-number">4.9/5</span>
                <span>average rating</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">üöÄ</span>
                <span class="social-stat-number">89%</span>
                <span>found perfect match</span>
            </div>
        </div>
        
        <div class="desktop-social-proof">
            <div class="social-proof-title">üíº Trusted by Businesses</div>
            <div class="social-stat">
                <span class="trust-badge-icon">üè™</span>
                <span>Retail Stores</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">üçΩÔ∏è</span>
                <span>Restaurants</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">üíÑ</span>
                <span>Beauty Salons</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">üéì</span>
                <span>Education Centers</span>
            </div>
        </div>
    </div>

    <!-- Desktop Ambient Right -->
    <div class="desktop-ambient-right">
        <div class="desktop-social-proof">
            <div class="social-proof-title">üìà Success Stories</div>
            <div class="social-stat">
                <span class="trust-badge-icon">üìä</span>
                <span class="social-stat-number">300%</span>
                <span>avg. lead increase</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">üí∞</span>
                <span class="social-stat-number">‚Çπ2L+</span>
                <span>monthly revenue boost</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">‚ö°</span>
                <span class="social-stat-number">48hrs</span>
                <span>average setup time</span>
            </div>
        </div>

        <div class="desktop-social-proof">
            <div class="social-proof-title">üîí Secure & Reliable</div>
            <div class="social-stat">
                <span class="trust-badge-icon">üõ°Ô∏è</span>
                <span>SSL Encrypted</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">‚òÅÔ∏è</span>
                <span>Cloud Backup</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">üìû</span>
                <span>24/7 Support</span>
            </div>
            <div class="social-stat">
                <span class="trust-badge-icon">üáÆüá≥</span>
                <span>Made in India</span>
            </div>
        </div>
    </div>

    <!-- Desktop Trust Badges -->
    <div class="desktop-trust-badges">
        <div class="trust-badge">
            <span class="trust-badge-icon">üîí</span>
            <span>100% Secure</span>
        </div>
        <div class="trust-badge">
            <span class="trust-badge-icon">‚ö°</span>
            <span>Instant Results</span>
        </div>
        <div class="trust-badge">
            <span class="trust-badge-icon">üÜì</span>
            <span>Completely Free</span>
        </div>
        <div class="trust-badge">
            <span class="trust-badge-icon">üéØ</span>
            <span>Personalized</span>
        </div>
    </div>

    <!-- Desktop Wrapper -->
    <div class="desktop-wrapper">
        <div class="mobile-container">
        <!-- Social Proof Messages -->
        <div id="socialProof" class="social-proof" style="display: none;"></div>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        

        <!-- Mobile Profile Bar -->
        <div class="mobile-profile" id="mobileProfile" style="display: none;">
            <div class="profile-avatar" id="profileAvatar">?</div>
            <div class="profile-info">
                <div class="profile-name" id="profileName">Building your profile...</div>
                <div class="profile-status" id="profileStatus">Answer questions to get started</div>
            </div>
        </div>

        <!-- Landing Screen -->
        <div id="landingScreen" class="screen active">
            <div class="landing-container">
                <!-- Topiko Logo -->
                <div class="landing-logo">
                    <img src="/logo.png" alt="Topiko" style="height: 100px; margin-bottom: 32px;">
                </div>
                
                <!-- Welcome Message -->
                <div class="landing-content">
                    <h1 class="landing-title">Take Control of Your Digital Presence</h1>
                    <p class="landing-subtitle">See what digital tools fit your business - personalized plan in 2 minutes, completely free</p>
                    <div class="landing-benefits">
                        <div class="benefit-item">
                            <div class="benefit-icon">üìã</div>
                            <div class="benefit-text">Free personalized plan</div>
                        </div>
                        <div class="benefit-item">
                            <div class="benefit-icon">üè¢</div>
                            <div class="benefit-text">10,000+ businesses</div>
                        </div>
                        <div class="benefit-item">
                            <div class="benefit-icon">‚ö°</div>
                            <div class="benefit-text">Ready in 2 minutes</div>
                        </div>
                        <div class="benefit-item">
                            <div class="benefit-icon">üí≥</div>
                            <div class="benefit-text">No credit card</div>
                        </div>
                        <div class="benefit-item">
                            <div class="benefit-icon">üë®‚Äçüíº</div>
                            <div class="benefit-text">Expert consultation included</div>
                        </div>
                        <div class="benefit-item">
                            <div class="benefit-icon">üõ°Ô∏è</div>
                            <div class="benefit-text">Zero risk</div>
                        </div>
                    </div>
                </div>
                
                <!-- Start Button -->
                <button class="btn btn-large landing-start-btn" id="startAssessmentBtn">üöÄ See What My Business Needs</button>

                <!-- Testimonials Section -->
                <div class="testimonials-section">
                    <div class="testimonial">
                        <div class="testimonial-text">"Quick assessment, perfect recommendations - wish I found this sooner"</div>
                        <div class="testimonial-author">‚Äî Fitness Studio Owner, Tirupati</div>
                        <div class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    </div>

                    <div class="testimonial">
                        <div class="testimonial-text">"Got exactly the roadmap my business needed to grow online"</div>
                        <div class="testimonial-author">‚Äî Handicrafts Seller, Goa</div>
                        <div class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- OTP Validation Screen -->
        <div id="otpScreen" class="screen">
            <div class="question-card">
                <div class="question-title">Let's verify your WhatsApp number</div>
                <p class="question-subtitle">We'll send your personalized plan here. No spam, ever!</p>
                
                <div class="form-group">
                    <label class="form-label">WhatsApp Number</label>
                    <div class="phone-input-container">
                        <select class="country-code" id="countryCode">
                            <option value="+91">üáÆüá≥ +91</option>
                            <option value="+1">üá∫üá∏ +1</option>
                            <option value="+44">üá¨üáß +44</option>
                            <option value="+971">üá¶üá™ +971</option>
                        </select>
                        <input type="tel" class="form-input phone-input" id="phoneNumber" placeholder="Enter your WhatsApp number" maxlength="10">
                    </div>
                </div>
                
                <button class="btn btn-large" id="sendOtpBtn" onclick="sendOTP()" disabled>Send OTP</button>
                
                <div id="otpSection" style="display: none;">
                    <div class="form-group" style="margin-top: 20px;">
                        <label class="form-label">Enter 6-digit OTP</label>
                        <input type="text" class="form-input otp-input" id="otpInput" placeholder="000000" maxlength="6">
                    </div>
                    
                    <div class="otp-timer" id="otpTimer">Resend OTP in <span id="countdown">60</span>s</div>
                    
                    <button class="btn btn-large" id="verifyOtpBtn" onclick="verifyOTP()" disabled>Verify & Continue</button>
                    <button class="btn btn-secondary" id="resendOtpBtn" onclick="resendOTP()" style="display: none;">Resend OTP</button>
                </div>
            </div>
        </div>

        <!-- Screen 1: Basic Info -->
        <div id="screen1" class="screen">
            <div class="question-card">
                <div class="question-title">Let's get started! Tell us about yourself</div>
                
                <div class="question-title" style="margin-top: 20px;">What's your name?</div>
                <input type="text" class="form-input" id="fullName" placeholder="Enter your full name">
                
                <div id="businessNameSection" style="display: none;">
                    <div class="question-title">What's your business name?</div>
                    <input type="text" class="form-input" id="businessName" placeholder="Enter your business name">
                </div>
                
                <div id="businessTypeSection" style="display: none;">
                    <div class="question-title">What type of business?</div>
                    <select class="form-input" id="businessType" style="height: 48px;">
                        <option value="">Select your business type</option>
                        <option value="Retail Store">Retail Store</option>
                        <option value="Restaurant/Cafe">Restaurant/Cafe</option>
                        <option value="Salon/Spa">Salon/Spa</option>
                        <option value="Healthcare/Clinic">Healthcare/Clinic</option>
                        <option value="Education/Training">Education/Training</option>
                        <option value="Construction/Real Estate">Construction/Real Estate</option>
                        <option value="Automotive">Automotive</option>
                        <option value="Fashion/Apparel">Fashion/Apparel</option>
                        <option value="Jewelry">Jewelry</option>
                        <option value="Creative Services">Creative Services</option>
                        <option value="IT/Software Services">IT/Software Services</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Logistics/Transport">Logistics/Transport</option>
                        <option value="Agency/Marketing">Agency/Marketing</option>
                        <option value="B2B Services">B2B Services</option>
                        <option value="Professional Services">Professional Services</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div id="cityLocationSection" style="display: none;">
                    <div class="question-title">Which city are you in?</div>
                    <input type="text" class="form-input" id="cityLocation" placeholder="Enter your city">
                </div>
                
                <!-- Single arrow that moves to bottom of current section -->
                <div class="next-indicator" id="nextIndicator" onclick="handleNextClick()">
                    <svg viewBox="0 0 24 24">
                        <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                    </svg>
                </div>
                
                <button class="btn" id="continueBtn" style="display: none;">Continue to Assessment</button>
                
                <!-- Progressive Insight Container -->
                <div id="insightContainer1" class="insight-container" style="display: none;">
                    <div class="insight-content">
                        <div class="insight-icon">üí°</div>
                        <div class="insight-text" id="insightText1"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen 2: Business Assessment -->
        <div id="screen2" class="screen">
            <div class="chat-message" id="chatMessage2">Great! Now let's understand your business better.</div>
            
            <div class="question-card">
                <div class="question-title" id="currentQuestion">What type of business do you run?</div>
                <div id="questionContent">
                    <!-- Dynamic content will be inserted here -->
                </div>
                
                <div class="nav-buttons">
                    <button class="btn btn-secondary" id="backBtn" onclick="previousQuestion()">Back</button>
                    <button class="btn" id="nextBtn" disabled onclick="nextQuestion()">Next</button>
                </div>
                
                <!-- Progressive Insight Container -->
                <div id="insightContainer2" class="insight-container" style="display: none;">
                    <div class="insight-content">
                        <div class="insight-icon">üìä</div>
                        <div class="insight-text" id="insightText2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen 3: Results -->
        <div id="screen3" class="screen">
            <div class="chat-message" id="chatMessage3">üéâ Congratulations! Your personalized digital strategy is ready.</div>
            
            <div class="results-container">
                <!-- Main Recommendation Card -->
                <div class="recommendation-card primary-card" id="primaryRecommendation">
                    <div class="card-header">
                        <div class="card-icon">üíé</div>
                        <div class="card-title">RECOMMENDED FOR YOU</div>
                    </div>
                    
                    <div class="product-name" id="primaryProductName">Disblay Website</div>
                    <div class="product-divider"></div>
                    
                    <div class="features-list" id="primaryFeatures">
                        <div class="feature-item">‚úì Product showcase website</div>
                        <div class="feature-item">‚úì WhatsApp-friendly links</div>
                        <div class="feature-item">‚úì Payment & shipping integration</div>
                        <div class="feature-item">‚úì Mobile-first design</div>
                        <div class="feature-item">‚úì Easy to update yourself</div>
                    </div>
                    
                    <div class="pricing" id="primaryPricing">Just ‚Çπ1,499/year</div>
                    
                    <button class="consultation-btn" id="consultationBtn" onclick="skipAuditAndBookCall()">
                        üìû Book 10-Min Consultation
                    </button>
                </div>

                <!-- Marketing Add-on Card -->
                <div class="recommendation-card marketing-card" id="marketingRecommendation" style="display: none;">
                    <div class="marketing-divider"></div>
                    
                    <div class="marketing-header" id="marketingHeader">
                        <div class="marketing-icon">üì¢</div>
                        <div class="marketing-title">Want Customer Inquiries Too?</div>
                    </div>
                    
                    <div class="marketing-product">Add Digital Marketing</div>
                    <div class="marketing-price" id="marketingPrice">Starting from ‚Çπ10,000/month</div>
                    
                    <div class="marketing-features">
                        <div class="feature-item">‚úì Social media campaigns</div>
                        <div class="feature-item">‚úì Google/Facebook ads</div>
                        <div class="feature-item">‚úì Lead generation</div>
                        <div class="feature-item">‚úì Month-to-month (no lock-in)</div>
                    </div>
                    
                    <div class="marketing-cta">Discuss in consultation ‚Üó</div>
                </div>

                <!-- Alternative/Bundle Card -->
                <div class="recommendation-card bundle-card" id="bundleRecommendation" style="display: none;">
                    <div class="bundle-divider"></div>
                    
                    <div class="bundle-header">
                        <div class="bundle-icon">üéØ</div>
                        <div class="bundle-title">COMPLETE SOLUTION</div>
                    </div>
                    
                    <div class="bundle-content" id="bundleContent">
                        <!-- Bundle content will be populated by routing logic -->
                    </div>
                    
                    <div class="bundle-cta">
                        <button class="consultation-btn secondary" onclick="skipAuditAndBookCall()">
                            Discuss Package Options
                        </button>
                    </div>
                </div>

                <!-- Consultation Preview -->
                <div class="consultation-preview">
                    <div class="preview-header">
                        <div class="preview-icon">üí¨</div>
                        <div class="preview-title">In your 10-minute consultation:</div>
                    </div>
                    <div class="preview-content" id="consultationPreview">
                        <div class="preview-item">‚Ä¢ See your recommended solution with examples</div>
                        <div class="preview-item">‚Ä¢ Get exact pricing & timeline</div>
                        <div class="preview-item">‚Ä¢ Try free for 7 days if unsure</div>
                        <div class="preview-item" id="customPreviewItem"></div>
                    </div>
                    <div class="preview-footer">Quick call. No pressure. Just showing you what's possible.</div>
                </div>
            </div>
        </div>

        <!-- Screen 5: Professional Digital Audit -->
        <div id="screen4" class="screen">
            <div class="chat-message" id="chatMessage4">üéØ Let's create your personalized digital roadmap! I'll ask a few targeted questions to build your detailed action plan.</div>
            
            <!-- Audit Progress Bar -->
            <div class="audit-progress">
                <div class="audit-progress-fill" id="auditProgressFill" style="width: 12.5%;"></div>
            </div>
            
            <div class="audit-question-card">
                <div class="audit-question-header">
                    <div class="audit-question-number" id="auditQuestionNumber">1</div>
                    <div class="audit-category" id="auditCategory">Technical Infrastructure</div>
                </div>
                
                <div class="audit-question-title" id="auditQuestion">Do you own a domain name for your business?</div>
                
                <div class="audit-explanation" id="auditExplanation">
                    A domain is your web address (like yourbusiness.com). We can help you choose and register the perfect domain that matches your brand.
                </div>
                
                <div class="audit-options" id="auditOptions">
                    <div class="audit-option" data-value="yes" onclick="handleAuditAnswer('yes')">
                        ‚úÖ Yes, I have one
                    </div>
                    <div class="audit-option" data-value="no" onclick="handleAuditAnswer('no')">
                        ‚ùå No, I need help
                    </div>
                    <div class="audit-option" data-value="unsure" onclick="handleAuditAnswer('unsure')">
                        ü§î I'm not sure
                    </div>
                </div>
                
                <div class="audit-navigation">
                    <div class="audit-nav-info" id="auditNavInfo">Question 1 of 8</div>
                    <button class="audit-next-btn" onclick="nextAuditQuestion()" id="auditNextBtn" disabled>Next Question</button>
                </div>
            </div>
        </div>

        <!-- Screen 6: Detailed Plan Results -->
        <div id="screen5" class="screen">
            <div class="chat-message" id="chatMessage4">üéâ Your personalized digital roadmap is ready! Here's your comprehensive action plan.</div>
            
            <div class="plan-container" id="detailedPlanContent">
                <!-- Detailed plan will be generated here -->
            </div>
            
            <div class="plan-actions">
                <button class="plan-btn plan-btn-primary" onclick="showScheduleModal()">üìû Schedule Call</button>
                <button class="plan-btn plan-btn-secondary" onclick="downloadPlan()">üìÑ Download Plan</button>
            </div>
        </div>
    </div>

    <!-- Schedule Call Modal -->
    <div id="scheduleModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìû Schedule Your Expert Call</h3>
                <span class="close" onclick="closeScheduleModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">Select your preferred time slot for our digital transformation expert to call you:</p>
                <div id="timeSlots" class="time-slots"></div>
                <div style="margin-top: 20px; font-size: 14px; color: #888;">
                    ‚è∞ All times are in IST (Indian Standard Time)<br>
                    üìû Our expert will call you at the selected time
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://uyaubwfmxmxelcshuyaf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5YXVid2ZteG14ZWxjc2h1eWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NDA0MTksImV4cCI6MjA2OTUxNjQxOX0.Sc9qUUXr73x8yw5-2rs-pcI03lFpMTSyuhW9RDLcOLI';
        
        // Initialize Supabase
        let supabase;
        let sessionId = generateSessionId();
        let assessmentId = null;
        
        try {
            if (typeof window.supabase !== 'undefined') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase initialized successfully');
            } else {
                console.warn('‚ö†Ô∏è Supabase not available');
            }
        } catch (error) {
            console.error('‚ùå Error initializing Supabase:', error);
        }
        
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Desktop users get responsive layout (no redirect needed)
        function checkDevice() {
            return true; // Always return true, responsive CSS handles desktop
        }
        
        // Check on load and resize
        if (checkDevice()) {
            window.addEventListener('resize', checkDevice);
        }
        
        let currentScreen = 0; // 0 = landing, 1 = basic info, 2 = assessment, etc.
        let currentStep = 0; // 0=name only, 1=+business name, 2=+type, 3=+city, 4=complete
        let currentQuestionIndex = 0;
        let inputTimeout;
        let formData = {
            // Screen 1: Phone Verification
            phone_number: '',
            phone_verified: false,
            
            // Screen 2: Basic Information
            name: '',
            business_name: '',
            email: '',
            business_type: '',
            city: '',
            
            // Screen 3: Goals (Multi-select - can be multiple true)
            goal_more_customers: false,
            goal_showcase: false,
            goal_branding: false,
            goal_website: false,
            goal_app: false,
            goal_custom: false,
            goal_whitelabel: false,
            goal_unsure: false,
            
            // Screen 4: Current Digital Presence (Single select)
            digital_presence: '',
            
            // Screen 5: Challenge & Urgency (Single select)
            challenge_urgency: '',
            
            // Legacy fields for backward compatibility
            fullName: '',
            businessName: '',
            businessType: '',
            cityLocation: '',
            goals: [],
            digitalStatus: '',
            budget: '',
            challenge: '',
            mobileNumber: '',
            otpVerified: false
        };
        
        let auditData = {};
        let currentAuditIndex = 0;
        let auditQuestions = [];
        let recommendedProduct = '';

        // Professional Audit Questions are now product-specific
        // Each product has its own focused question set
        
        // Assessment questions for Screen 2
        const questions = [
            {
                id: 'goals',
                question: 'Okay [Name], what brings you here today?\nSelect all that apply',
                type: 'checkbox',
                options: [
                    { value: 'goal_more_customers', label: 'üì¢ Need more customers' },
                    { value: 'goal_showcase', label: 'üè™ Showcase my products/services' },
                    { value: 'goal_branding', label: 'üé® Create/improve my branding' },
                    { value: 'goal_website', label: 'üåê Build professional website' },
                    { value: 'goal_app', label: 'üì± Need mobile app' },
                    { value: 'goal_custom', label: 'üîß Custom solution' },
                    { value: 'goal_whitelabel', label: 'ü§ù White-label solutions' },
                    { value: 'goal_unsure', label: '‚ùì Not sure where to start' }
                ]
            },
            {
                id: 'digital_presence',
                question: 'What\'s your current digital presence?',
                type: 'radio',
                options: [
                    { value: 'starting_out', label: 'üå± Just starting out - No digital presence yet' },
                    { value: 'basic', label: 'üí¨ Basic presence only - WhatsApp Business / Google listing' },
                    { value: 'have_website', label: 'üåê Have a website - But not getting results' },
                    { value: 'active', label: 'üìà Active online - But want to scale further' }
                ]
            },
            {
                id: 'challenge_urgency',
                question: 'Last question! What\'s your biggest challenge right now?',
                type: 'radio',
                options: [
                    { value: 'immediate_need_customers', label: 'üö® Not getting enough customers - Need solution ASAP' },
                    { value: 'have_presence_no_results', label: 'üìâ Have presence but no results - Looking to improve in 1-3 months' },
                    { value: 'exploring_dont_know', label: 'ü§î Don\'t know where to start - Want to explore options (3-6 months)' },
                    { value: 'no_time_need_management', label: '‚è∞ No time to handle digital - Need someone to manage it all' }
                ]
            }
        ];

        // OTP Functions
        let otpCountdown = 60;
        let countdownInterval;

        function validatePhoneNumber() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const sendOtpBtn = document.getElementById('sendOtpBtn');
            
            if (phoneNumber.length >= 10 && /^\d+$/.test(phoneNumber)) {
                sendOtpBtn.disabled = false;
                sendOtpBtn.style.opacity = '1';
            } else {
                sendOtpBtn.disabled = true;
                sendOtpBtn.style.opacity = '0.5';
            }
        }

        function sendOTP() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const countryCode = document.getElementById('countryCode').value;
            const fullNumber = countryCode + phoneNumber;
            
            // Store phone number
            formData.phoneNumber = fullNumber;
            formData.phone_number = fullNumber; // New field for routing
            
            // Show OTP section
            document.getElementById('otpSection').style.display = 'block';
            document.getElementById('sendOtpBtn').style.display = 'none';
            
            // Start countdown
            startCountdown();
            
            // Simulate OTP send (replace with actual API call)
            console.log('OTP sent to:', fullNumber);
            
            // For demo, auto-fill OTP after 2 seconds
            setTimeout(() => {
                // document.getElementById('otpInput').value = '123456';
                // validateOTP();
            }, 2000);
        }

        function startCountdown() {
            otpCountdown = 60;
            const countdownElement = document.getElementById('countdown');
            const resendBtn = document.getElementById('resendOtpBtn');
            const timerElement = document.getElementById('otpTimer');
            
            resendBtn.style.display = 'none';
            timerElement.style.display = 'block';
            
            countdownInterval = setInterval(() => {
                countdownElement.textContent = otpCountdown;
                otpCountdown--;
                
                if (otpCountdown < 0) {
                    clearInterval(countdownInterval);
                    timerElement.style.display = 'none';
                    resendBtn.style.display = 'block';
                }
            }, 1000);
        }

        function validateOTP() {
            const otpInput = document.getElementById('otpInput').value;
            const verifyBtn = document.getElementById('verifyOtpBtn');
            
            if (otpInput.length === 6 && /^\d+$/.test(otpInput)) {
                verifyBtn.disabled = false;
                verifyBtn.style.opacity = '1';
            } else {
                verifyBtn.disabled = true;
                verifyBtn.style.opacity = '0.5';
            }
        }

        function verifyOTP() {
            const otpInput = document.getElementById('otpInput').value;
            
            // Simulate OTP verification (replace with actual API call)
            if (otpInput === '123456' || otpInput.length === 6) {
                // OTP verified successfully
                document.getElementById('otpScreen').classList.remove('active');
                document.getElementById('screen1').classList.add('active');
                currentScreen = 1;
                updateProgress();
            } else {
                alert('Invalid OTP. Please try again.');
            }
        }

        function resendOTP() {
            sendOTP();
        }

        // Initialize event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Landing page start button
            document.getElementById('startAssessmentBtn').addEventListener('click', function() {
                document.getElementById('landingScreen').classList.remove('active');
                document.getElementById('otpScreen').classList.add('active');
                currentScreen = 0.5; // Between landing and screen1
                updateProgress();
                
                // Initialize social proof after starting assessment
                setTimeout(() => showSocialProof(), 3000);
            });

            // OTP form event listeners
            document.getElementById('phoneNumber').addEventListener('input', validatePhoneNumber);
            document.getElementById('otpInput').addEventListener('input', validateOTP);
            
            // Screen 1 inputs
            document.getElementById('fullName').addEventListener('input', handleNameInput);
            document.getElementById('businessName').addEventListener('input', handleBusinessNameInput);
            document.getElementById('businessType').addEventListener('change', handleBusinessTypeChange);
            document.getElementById('cityLocation').addEventListener('input', handleCityInput);
            document.getElementById('continueBtn').addEventListener('click', async () => {
                // Create assessment in database when user has provided basic info
                if (!assessmentId && formData.fullName && formData.businessName) {
                    await createAssessment();
                }
                showScreen(2);
            });
            
            // Screen 3 inputs
            document.getElementById('mobileNumber').addEventListener('input', handleContactInput);
            document.getElementById('otpInput').addEventListener('input', handleOTPInput);
            
            // Initialize first question
            loadQuestion(0);
            updateProgress();
        });

        function handleNameInput() {
            const fullName = document.getElementById('fullName').value.trim();
            formData.fullName = fullName;
            formData.name = fullName; // New field for routing
            
            // Clear previous timeout
            clearTimeout(inputTimeout);
            
            if (fullName.length > 2) {
                // Show next step indicator
                document.getElementById('nextIndicator').classList.add('show');
                currentStep = 1;
                updateProgress();
                
                updateProfile();
                
                // Debounced chat message update
                inputTimeout = setTimeout(() => {
                    const firstName = fullName.split(' ')[0];
                    const greetings = [
                        `Nice to meet you, ${firstName}! What's your business called?`,
                        `Welcome ${firstName}! Tell me about your business.`,
                        `Hello ${firstName}! Let's learn about your venture.`,
                        `Great to have you here, ${firstName}! What's your business name?`
                    ];
                    const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
                    document.getElementById('chatMessage1').textContent = randomGreeting;
                }, 1500);
            } else {
                // Hide indicator and subsequent sections
                document.getElementById('nextIndicator').classList.remove('show');
                hideAllSections();
            }
            
            validateScreen1();
        }
        
        function handleNextClick() {
            if (currentStep === 1) {
                // Show business name field and focus
                document.getElementById('businessNameSection').style.display = 'block';
                setTimeout(() => document.getElementById('businessName').focus(), 100);
            } else if (currentStep === 2) {
                // Show business type field and focus
                document.getElementById('businessTypeSection').style.display = 'block';
                setTimeout(() => document.getElementById('businessType').focus(), 100);
            } else if (currentStep === 3) {
                // Show city field and focus
                document.getElementById('cityLocationSection').style.display = 'block';
                setTimeout(() => document.getElementById('cityLocation').focus(), 100);
            }
        }
        
        // Removed old showStartButton function
        
        function hideAllSections() {
            document.getElementById('businessNameSection').style.display = 'none';
            document.getElementById('businessTypeSection').style.display = 'none';
            document.getElementById('cityLocationSection').style.display = 'none';
            document.getElementById('continueBtn').style.display = 'none';
            
            // Hide indicator
            document.getElementById('nextIndicator').classList.remove('show');
            currentStep = 0;
        }

        function handleBusinessNameInput() {
            const businessName = document.getElementById('businessName').value.trim();
            formData.businessName = businessName;
            formData.business_name = businessName; // New field for routing
            
            // Clear previous timeout
            clearTimeout(inputTimeout);
            
            if (businessName.length > 1) {
                // Show next step indicator
                currentStep = 2;
                updateProgress();
                updateProfile();
                
                // Debounced chat message update
                inputTimeout = setTimeout(() => {
                    const compliments = [
                        `${businessName} - sounds promising! What type of business is it?`,
                        `${businessName} - I like it! Tell me what industry you're in.`,
                        `${businessName} - excellent choice! What category best describes it?`,
                        `${businessName} - that's a solid name! What's your business type?`,
                        `${businessName} - love the branding potential! What industry are you in?`
                    ];
                    const randomCompliment = compliments[Math.floor(Math.random() * compliments.length)];
                    document.getElementById('chatMessage1').textContent = randomCompliment;
                }, 1500);
            } else {
                // Reset to previous step
                currentStep = 1;
                updateProgress();
                document.getElementById('businessTypeSection').style.display = 'none';
                document.getElementById('cityLocationSection').style.display = 'none';
                document.getElementById('continueBtn').style.display = 'none';
            }
            
            validateScreen1();
        }

        function handleBusinessTypeChange() {
            const businessType = document.getElementById('businessType').value;
            formData.businessType = businessType;
            formData.business_type = businessType; // New field for routing
            
            if (businessType) {
                // Show next step
                currentStep = 3;
                updateProgress();
                
                
                const typeMessages = {
                    retail: "Retail stores are perfect for digital transformation! Where are you located?",
                    restaurant: "Food businesses are booming online! üçï What's your city?",
                    salon: "Beauty services see amazing digital growth! ‚ú® Where's your salon?",
                    boutique: "Fashion brands love digital marketing! üëó What city are you in?",
                    services: "Professional services thrive online! üíº Where do you operate?",
                    healthcare: "Healthcare digitalization is the future! üè• What's your location?",
                    education: "EdTech is revolutionizing learning! üìö Where are you based?",
                    manufacturing: "Industry 4.0 is here! üè≠ What city are you in?",
                    consulting: "Consultants scale beautifully online! üìà Where do you work?",
                    fitness: "Fitness apps and online coaching are huge! üí™ What's your location?",
                    travel: "Travel booking systems drive great revenue! ‚úàÔ∏è Where are you based?",
                    real_estate: "PropTech is transforming real estate! üè† What city do you serve?",
                    automotive: "Auto services need strong digital presence! üöó Where's your business?",
                    electronics: "Tech businesses must stay cutting-edge! üíª What's your city?",
                    other: "Every business has digital potential! üöÄ Where are you located?"
                };
                
                setTimeout(() => {
                    document.getElementById('chatMessage1').textContent = typeMessages[businessType] || "Great choice! Where are you located?";
                }, 500);
                
                updateProfile();
            } else {
                // Reset to previous step
                currentStep = 2;
                updateProgress();
                document.getElementById('cityLocationSection').style.display = 'none';
                document.getElementById('continueBtn').style.display = 'none';
            }
            
            validateScreen1();
        }

        function handleCityInput() {
            const city = document.getElementById('cityLocation').value.trim();
            formData.cityLocation = city;
            formData.city = city; // New field for routing
            
            // Clear previous timeout
            clearTimeout(inputTimeout);
            
            if (city.length > 2) {
                // Show final step - replace arrow with button
                currentStep = 4;
                updateProgress();
                document.getElementById('nextIndicator').classList.remove('show');
                document.getElementById('continueBtn').style.display = 'block';
                updateProfile();
                
                // Debounced chat message update with completion message
                inputTimeout = setTimeout(() => {
                    const cityMessages = [
                        `${city} has great business potential! üåü Ready to start your assessment?`,
                        `${city} is perfect for digital growth! üìç Let's build your strategy!`,
                        `Love ${city}! Great market for your business! üéØ Shall we begin?`,
                        `${city} - excellent location for expansion! üöÄ Time to assess your digital readiness!`
                    ];
                    const randomCityMessage = cityMessages[Math.floor(Math.random() * cityMessages.length)];
                    document.getElementById('chatMessage1').textContent = randomCityMessage;
                }, 1500);
            } else {
                // Reset to previous step
                currentStep = 3;
                updateProgress();
                document.getElementById('nextIndicator').classList.add('show');
                document.getElementById('continueBtn').style.display = 'none';
            }
            
            validateScreen1();
        }

        function validateScreen1() {
            const continueBtn = document.getElementById('continueBtn');
            const isValid = formData.fullName.length > 2 && 
                           formData.businessName.length > 1 && 
                           formData.businessType && 
                           formData.cityLocation.length > 2;
            continueBtn.disabled = !isValid;
        }

        function updateProfile() {
            const profile = document.getElementById('mobileProfile');
            const avatar = document.getElementById('profileAvatar');
            const name = document.getElementById('profileName');
            const status = document.getElementById('profileStatus');
            
            if (formData.fullName) {
                profile.style.display = 'flex';
                avatar.textContent = formData.fullName.charAt(0).toUpperCase();
                
                const firstName = formData.fullName.split(' ')[0];
                if (formData.businessName) {
                    name.textContent = `${firstName} - ${formData.businessName}`;
                } else {
                    name.textContent = firstName;
                }
                
                // Update status based on current screen
                const statusMessages = {
                    1: 'Getting started...',
                    2: 'Assessment in progress...',
                    3: 'Almost complete!',
                    4: 'Assessment complete!'
                };
                status.textContent = statusMessages[currentScreen] || 'Building profile...';
            }
        }

        async function showScreen(screenNumber) {
            // Hide current screen
            if (currentScreen === 0) {
                document.getElementById('landingScreen').classList.remove('active');
            } else {
                document.getElementById(`screen${currentScreen}`).classList.remove('active');
            }
            
            // Show new screen
            currentScreen = screenNumber;
            if (currentScreen === 0) {
                document.getElementById('landingScreen').classList.add('active');
            } else {
                document.getElementById(`screen${currentScreen}`).classList.add('active');
            }
            
            // Update progress and profile
            updateProgress();
            updateProfile();
            
            // Save progress to database
            await saveAssessmentProgress();
            
            // Screen-specific initialization
            if (screenNumber === 2) {
                loadQuestion(0);
                setTimeout(() => showProgressiveInsight(1), 1500); // Show insight after profile completion
            } else if (screenNumber === 3) {
                setTimeout(() => showProgressiveInsight(2), 1000); // Show insight after goals completion
            } else if (screenNumber === 4) {
                generateResults();
                setTimeout(() => showProgressiveInsight(3), 2000); // Show insight after results
            }
            
        }

        function updateProgress() {
            let progress;
            if (currentScreen === 0) {
                // Landing screen - no progress yet
                progress = 0;
            } else if (currentScreen === 1) {
                // Screen 1 progress based on currentStep (0-4)
                progress = (currentStep / 4) * 25; // 25% for screen 1
            } else if (currentScreen === 2) {
                // Screen 2 - questions progress (25% to 75%)
                const questionProgress = currentQuestionIndex / questions.length;
                progress = 25 + (questionProgress * 50);
            } else if (currentScreen === 3) {
                // Screen 3 - contact (75% to 90%)
                progress = 75;
            } else if (currentScreen === 4) {
                // Screen 4 - results (100%)
                progress = 100;
            } else {
                // Fallback
                progress = 25 + ((currentScreen - 2) / 2) * 75;
            }
            
            // Hide progress bar and profile on landing screen
            const progressContainer = document.querySelector('.progress-container');
            const profileContainer = document.querySelector('.mobile-profile');
            if (currentScreen === 0) {
                progressContainer.style.display = 'none';
                profileContainer.style.display = 'none';
            } else {
                progressContainer.style.display = 'block';
                profileContainer.style.display = 'flex';
                document.getElementById('progressBar').style.width = `${progress}%`;
            }
        }

        // Question management for Screen 2
        function loadQuestion(index) {
            if (index >= questions.length) {
                showScreen(3);
                return;
            }
            
            currentQuestionIndex = index;
            const question = questions[index];
            
            // Personalize question text by replacing [Name] with user's first name
            let questionText = question.question;
            if (questionText.includes('[Name]') && formData.fullName) {
                const firstName = formData.fullName.split(' ')[0];
                questionText = questionText.replace('[Name]', firstName);
            }
            
            document.getElementById('currentQuestion').innerHTML = questionText.replace(/\n/g, '<br>');
            
            let html = '';
            
            if (question.type === 'radio') {
                question.options.forEach(option => {
                    const selected = formData[question.id] === option.value ? 'selected' : '';
                    html += `
                        <div class="option-card ${selected}" data-question="${question.id}" data-value="${option.value}">
                            ${option.icon ? `<div class="option-icon">${option.icon}</div>` : ''}
                            <div class="option-content">
                                <div class="option-title">${option.label}</div>
                                ${option.subtitle ? `<div class="option-subtitle">${option.subtitle}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            } else if (question.type === 'checkbox') {
                question.options.forEach(option => {
                    const checked = formData[question.id].includes(option.value) ? 'checked' : '';
                    html += `
                        <label class="checkbox-item">
                            <input type="checkbox" value="${option.value}" ${checked} data-question="${question.id}">
                            <span>${option.label}</span>
                        </label>
                    `;
                });
            }
            
            document.getElementById('questionContent').innerHTML = html;
            
            // Add event listeners for new content
            document.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', handleOptionSelect);
            });
            
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });
            
            // Add input handler for challenge other text
            const challengeOtherInput = document.getElementById('challengeOtherInput');
            if (challengeOtherInput) {
                challengeOtherInput.addEventListener('input', function() {
                    formData.challengeOther = this.value.trim();
                });
            }
            
            // Update navigation
            document.getElementById('backBtn').style.display = index > 0 ? 'inline-block' : 'none';
            validateCurrentQuestion();
        }

        function handleOptionSelect(e) {
            const card = e.currentTarget;
            const questionId = card.dataset.question;
            const value = card.dataset.value;
            
            // Clear previous selections for this question
            document.querySelectorAll(`[data-question="${questionId}"]`).forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            formData[questionId] = value;
            
            // Also set new field names for routing compatibility
            if (questionId === 'digital_presence') {
                formData.digitalStatus = value; // Keep legacy field
            } else if (questionId === 'challenge_urgency') {
                formData.challenge = value; // Keep legacy field
            }
            
            // Show/hide other text box for challenge question
            if (questionId === 'challenge') {
                const otherTextDiv = document.getElementById('otherChallengeText');
                if (otherTextDiv) {
                    if (value === 'other') {
                        otherTextDiv.style.display = 'block';
                        const otherInput = document.getElementById('challengeOtherInput');
                        if (otherInput) {
                            setTimeout(() => otherInput.focus(), 100);
                        }
                    } else {
                        otherTextDiv.style.display = 'none';
                        formData.challengeOther = '';
                    }
                }
            }
            
            updateProgress();
            validateCurrentQuestion();
            
            // Remove previous selections for this question
            document.querySelectorAll(`[data-question="${questionId}"]`).forEach(c => {
                c.classList.remove('selected');
            });
            
            // Select current option
            card.classList.add('selected');
            formData[questionId] = value;
            
            // Update chat message based on selection
            updateChatMessage(questionId, value);
            
            
            validateCurrentQuestion();
        }

        function handleCheckboxChange(e) {
            const checkbox = e.target;
            const questionId = checkbox.dataset.question;
            const value = checkbox.value;
            
            if (!Array.isArray(formData[questionId])) {
                formData[questionId] = [];
            }
            
            if (checkbox.checked) {
                if (!formData[questionId].includes(value)) {
                    formData[questionId].push(value);
                }
                // Also set the new boolean goal fields
                if (questionId === 'goals') {
                    formData[value] = true;
                }
            } else {
                formData[questionId] = formData[questionId].filter(v => v !== value);
                // Also unset the new boolean goal fields
                if (questionId === 'goals') {
                    formData[value] = false;
                }
            }
            
            
            // Add engaging messages for goals selection
            if (questionId === 'goals') {
                const goalMessages = {
                    get_customers: ["More customers = more revenue! üí∞", "Customer acquisition is key to growth! üéØ", "Let's build that customer pipeline! üöÄ"],
                    showcase_products: ["Visual storytelling sells! üì∏", "Show off your amazing work! ‚ú®", "Professional showcase drives trust! üåü"],
                    build_brand: ["Brand identity creates lasting value! üé®", "Strong branding = premium pricing! üíé", "Your brand is your business asset! üèÜ"],
                    create_website: ["Your 24/7 digital storefront! üè™", "Websites that work while you sleep! üí§", "Your digital headquarters! üè¢"],
                    custom_solution: ["Custom solutions drive real results! üéØ", "Tailored approach for unique needs! ‚ö°", "Bespoke systems that scale! üöÄ"]
                };
                
                if (checkbox.checked && goalMessages[value]) {
                    const messages = goalMessages[value];
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    document.getElementById('chatMessage2').textContent = randomMessage;
                }
                
                // Update based on total selected goals
                const totalGoals = formData.goals.length;
                if (totalGoals === 1) {
                    setTimeout(() => {
                        document.getElementById('chatMessage2').textContent = "Great start! Any other goals? The more I know, the better I can help! üòä";
                    }, 2000);
                } else if (totalGoals === 2) {
                    setTimeout(() => {
                        document.getElementById('chatMessage2').textContent = "Perfect! I'm getting a clear picture of your needs. Keep going! üìà";
                    }, 2000);
                } else if (totalGoals >= 3) {
                    setTimeout(() => {
                        document.getElementById('chatMessage2').textContent = "Wow! You're thinking big! I love ambitious entrepreneurs! üöÄ‚≠ê";
                    }, 2000);
                }
            }
            
            validateCurrentQuestion();
        }

        function updateChatMessage(questionId, value) {
            const messages = {
                digitalStatus: {
                    none: "Perfect blank canvas! We'll build something amazing.",
                    whatsapp_only: "Smart start! Let's expand your reach.",
                    basic_website: "Good foundation! Time to optimize it.",
                    active_no_results: "Let's diagnose and fix that!"
                },
                budget: {
                    below_2k: "Smart budgeting! We'll maximize every rupee.",
                    '2k_10k': "Perfect range for serious growth!",
                    '10k_25k': "Ready for scale! Let's optimize.",
                    '25k_plus': "Enterprise level! Custom solutions await."
                },
                challenge: {
                    not_getting_leads: "We'll fix your lead pipeline!",
                    low_sales: "Time to convert that traffic and boost sales!",
                    dont_know_start: "That's why I'm here! We'll guide you step-by-step.",
                    no_time: "We'll handle everything for you!"
                },
                timeline: {
                    immediate: "Urgent needs require smart solutions! ‚ö°",
                    '1_3_months': "Perfect timeline for solid growth! üìà",
                    '3_6_months': "Strategic planning pays off! üéØ",
                    exploring: "Smart to explore options first! üîç"
                },
                brandHelp: {
                    yes: "Great branding is a game-changer! üé®",
                    improve: "Brand evolution keeps you competitive! ‚ú®",
                    no: "Strong existing brand is an asset! ‚úÖ"
                }
            };
            
            if (messages[questionId] && messages[questionId][value]) {
                document.getElementById('chatMessage2').textContent = messages[questionId][value];
            }
        }

        function validateCurrentQuestion() {
            const question = questions[currentQuestionIndex];
            const nextBtn = document.getElementById('nextBtn');
            let isValid = false;
            
            if (question.type === 'radio') {
                isValid = !!formData[question.id];
            } else if (question.type === 'checkbox') {
                isValid = formData[question.id] && formData[question.id].length > 0;
            }
            
            nextBtn.disabled = !isValid;
        }

        function nextQuestion() {
            loadQuestion(currentQuestionIndex + 1);
            updateProgress();
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            } else {
                showScreen(1);
            }
        }

        // Screen 3 Contact handling
        function handleContactInput() {
            const mobile = document.getElementById('mobileNumber').value.trim();
            
            formData.mobileNumber = mobile;
            
            const otpBtn = document.getElementById('otpBtn');
            const isValid = mobile.length === 10 && /^\d+$/.test(mobile);
            
            otpBtn.disabled = !isValid;
            
            if (isValid && !formData.otpSent) {
                otpBtn.textContent = 'Send OTP';
                updateProgress(); // Update progress when valid number entered
            }
        }

        async function handleOTP() {
            if (!formData.otpSent) {
                // Send real OTP
                const mobile = document.getElementById('mobileNumber').value.trim();
                if (!mobile || mobile.length !== 10) {
                    document.getElementById('otpStatus').textContent = 'Please enter a valid 10-digit mobile number';
                    return;
                }
                
                // Check for bypass numbers
                const bypassNumbers = ['8858868889', '5010000000'];
                const isBypassNumber = bypassNumbers.includes(mobile);
                
                if (isBypassNumber) {
                    // For bypass numbers, use demo mode
                    formData.actualOTP = '1111';
                    document.getElementById('otpSection').style.display = 'block';
                    document.getElementById('otpBtn').textContent = 'View My Results';
                    formData.otpSent = true;
                    updateProgress();
                    document.getElementById('otpStatus').textContent = 'Demo mode: Use 1111 as verification code';
                    document.getElementById('chatMessage3').textContent = 'Demo mode activated! Enter 1111 to continue.';
                    return;
                }
                
                // Generate 4-digit OTP for regular numbers
                formData.actualOTP = Math.floor(1000 + Math.random() * 9000).toString();
                const message = `Your Topiko verification code is: ${formData.actualOTP}. Valid for 10 minutes.`;
                
                document.getElementById('otpBtn').textContent = 'Sending...';
                document.getElementById('otpBtn').disabled = true;
                
                try {
                    console.log('Sending OTP to:', mobile, 'OTP:', formData.actualOTP);
                    
                    const response = await fetch('/api/send-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            mobile: mobile,
                            otp: formData.actualOTP,
                            message: message
                        })
                    });
                    
                    console.log('Response status:', response.status);
                    
                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    if (result.success) {
                        document.getElementById('otpSection').style.display = 'block';
                        document.getElementById('otpBtn').textContent = 'View My Results';
                        formData.otpSent = true;
                        updateProgress();
                        document.getElementById('otpStatus').textContent = 'Verification code sent to your mobile';
                        document.getElementById('chatMessage3').textContent = 'Verification code sent! Please check your mobile.';
                    } else {
                        console.error('OTP Send Failed:', result);
                        // Show OTP section with fallback
                        document.getElementById('otpSection').style.display = 'block';
                        formData.actualOTP = '1111'; // Fallback OTP
                        formData.otpSent = true;
                        updateProgress();
                        document.getElementById('otpStatus').textContent = `SMS service temporarily unavailable. Use 1111 as verification code.`;
                        document.getElementById('otpBtn').textContent = 'View My Results';
                        document.getElementById('chatMessage3').textContent = 'SMS service issue. Use 1111 to continue.';
                    }
                } catch (error) {
                    console.error('OTP Network Error:', error);
                    // Show OTP section with fallback for network errors too
                    document.getElementById('otpSection').style.display = 'block';
                    formData.actualOTP = '1111'; // Fallback OTP
                    formData.otpSent = true;
                    updateProgress();
                    document.getElementById('otpStatus').textContent = 'Network issue detected. Use 1111 as verification code.';
                    document.getElementById('otpBtn').textContent = 'View My Results';
                    document.getElementById('chatMessage3').textContent = 'Network issue. Use 1111 to continue.';
                }
            } else if (formData.otpVerified) {
                // Show results
                showScreen(4);
            }
        }

        function handleOTPInput() {
            const otp = document.getElementById('otpInput').value.trim();
            const otpBtn = document.getElementById('otpBtn');
            const mobile = document.getElementById('mobileNumber').value.trim();
            
            console.log('OTP Validation:', {
                enteredOTP: otp,
                expectedOTP: formData.actualOTP,
                mobile: mobile,
                isBypassNumber: ['8858868889', '5010000000'].includes(mobile)
            });
            
            if (otp.length === 4) {
                // Check for bypass numbers
                const bypassNumbers = ['8858868889', '5010000000'];
                const isBypassNumber = bypassNumbers.includes(mobile);
                
                // Only allow 1111 for bypass numbers or when actualOTP is set to 1111 (SMS failures)
                const isValidOTP = (otp === formData.actualOTP) || 
                                 (otp === '1111' && (isBypassNumber || formData.actualOTP === '1111'));
                
                console.log('OTP Check Result:', { isValidOTP, isBypassNumber, actualOTP: formData.actualOTP });
                
                if (isValidOTP) {
                    formData.otpVerified = true;
                    formData.phone_verified = true; // New field for routing
                    otpBtn.disabled = false;
                    document.getElementById('otpStatus').textContent = '‚úÖ Verified! Click to view results.';
                    document.getElementById('chatMessage3').textContent = '‚úÖ Verified! Click to view your results.';
                } else {
                    formData.otpVerified = false;
                    otpBtn.disabled = true;
                    document.getElementById('otpStatus').textContent = '‚ùå Invalid code. Please try again.';
                }
            } else {
                formData.otpVerified = false;
                otpBtn.disabled = true;
                document.getElementById('otpStatus').textContent = 'Enter the verification code sent to your mobile';
            }
        }

        // TOPIKO FUNNEL ROUTING LOGIC - IMPLEMENTATION
        function routeLead(data) {
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // STEP 1: PRIORITY ROUTING (Override everything)
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          if (data.goal_whitelabel === true) {
            return {
              team: "Flex Team",
              primary_product: "Flex White-Label Platform",
              price: "Custom pricing (discuss in call)",
              marketing_addon: false,
              priority: 1,
              call_within: "2 hours",
              expected_aov: "‚Çπ50,000+",
              consultation_notes: [
                "B2B sale - different approach",
                "Understand their client volume",
                "Show white-label demo",
                "Discuss partnership vs licensing"
              ]
            };
          }
          
          if (data.goal_custom === true || data.goal_app === true) {
            return {
              team: "HEBT Team",
              primary_product: "HEBT Custom Development",
              price: "‚Çπ50,000+ (project-based)",
              marketing_addon: false,
              priority: 1,
              call_within: "4 hours",
              expected_aov: "‚Çπ50,000 - ‚Çπ3,00,000",
              consultation_notes: [
                "Understand project scope",
                "Show similar projects",
                "Discuss timeline and milestones",
                "Custom pricing based on requirements"
              ]
            };
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // STEP 2: DIGITAL MATURITY ASSESSMENT
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          let maturity_level;
          let base_product;
          
          switch(data.digital_presence) {
            case "starting_out":
              maturity_level = 0;
              base_product = "GMB_or_Disblay";
              break;
            case "basic":
              maturity_level = 1;
              base_product = "Disblay_or_Topiko";
              break;
            case "have_website":
              maturity_level = 2;
              base_product = "Marketing_or_Optimization";
              break;
            case "active":
              maturity_level = 3;
              base_product = "Marketing_Advanced_or_HEBT";
              break;
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // STEP 3: URGENCY & PRIORITY SCORING
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          let urgency_score;
          let call_timing;
          let priority;
          let challenge_type;
          
          switch(data.challenge_urgency) {
            case "immediate_need_customers":
              urgency_score = 4;
              call_timing = "2 hours";
              priority = 1;
              challenge_type = "leads";
              break;
            case "have_presence_no_results":
              urgency_score = 3;
              call_timing = "24 hours";
              priority = 2;
              challenge_type = "optimization";
              break;
            case "exploring_dont_know":
              urgency_score = 2;
              call_timing = "48 hours";
              priority = 3;
              challenge_type = "awareness";
              break;
            case "no_time_need_management":
              urgency_score = 3;
              call_timing = "24 hours";
              priority = 2;
              challenge_type = "time";
              break;
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // STEP 4: GOAL-BASED PRODUCT MATCHING
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          let product_recommendation = {};
          let marketing_push_strength = "medium";
          
          // COMBINATION 1: Need customers + Showcase products
          if (data.goal_more_customers && data.goal_showcase) {
            product_recommendation = {
              primary: "Disblay",
              primary_price: "‚Çπ1,499",
              marketing_addon: true,
              marketing_price: "‚Çπ10,000/month",
              pitch: "Get online + start getting customer inquiries",
              expected_aov: "‚Çπ11,499 - ‚Çπ21,499"
            };
            marketing_push_strength = "high";
          }
          
          // COMBINATION 2: Branding + Website
          else if (data.goal_branding && data.goal_website) {
            product_recommendation = {
              primary: "Topiko + Brandpreneuring",
              primary_price: "‚Çπ13,000 - ‚Çπ17,000",
              marketing_addon: true,
              marketing_price: "‚Çπ10,000/month (optional)",
              pitch: "Professional brand + professional website",
              expected_aov: "‚Çπ13,000 - ‚Çπ27,000"
            };
            marketing_push_strength = "medium";
          }
          
          // COMBINATION 3: Branding + Showcase
          else if (data.goal_branding && data.goal_showcase) {
            product_recommendation = {
              primary: "Disblay + Brandpreneuring",
              primary_price: "‚Çπ9,499",
              marketing_addon: true,
              marketing_price: "‚Çπ10,000/month (optional)",
              pitch: "Professional brand + product showcase",
              expected_aov: "‚Çπ9,499 - ‚Çπ19,499"
            };
            marketing_push_strength = "medium";
          }
          
          // COMBINATION 4: Need customers + Branding
          else if (data.goal_more_customers && data.goal_branding) {
            product_recommendation = {
              primary: "Brandpreneuring",
              primary_price: "‚Çπ8,000",
              marketing_addon: true,
              marketing_price: "‚Çπ10,000/month",
              pitch: "Create professional brand + promote it to get customers",
              expected_aov: "‚Çπ18,000 - ‚Çπ28,000"
            };
            marketing_push_strength = "high";
          }
          
          // SINGLE GOALS - If no combination matched
          else if (data.goal_showcase === true) {
            product_recommendation = {
              primary: "Disblay",
              primary_price: "‚Çπ1,499",
              marketing_addon: true,
              marketing_price: "‚Çπ10,000/month (optional)",
              pitch: "Get your products online and shareable",
              expected_aov: "‚Çπ1,499 - ‚Çπ11,499"
            };
          }
          
          else if (data.goal_website === true) {
            product_recommendation = {
              primary: "Topiko",
              primary_price: "‚Çπ5,000 - ‚Çπ9,000",
              marketing_addon: true,
              marketing_price: "‚Çπ10,000/month (optional)",
              pitch: "Professional website with your custom domain",
              expected_aov: "‚Çπ5,000 - ‚Çπ19,000"
            };
          }
          
          else if (data.goal_branding === true) {
            product_recommendation = {
              primary: "Brandpreneuring",
              primary_price: "‚Çπ8,000",
              marketing_addon: true,
              marketing_price: "‚Çπ10,000/month (optional)",
              pitch: "Create professional brand identity",
              expected_aov: "‚Çπ8,000 - ‚Çπ18,000"
            };
          }
          
          else if (data.goal_more_customers === true) {
            product_recommendation = {
              primary: "Digital Marketing Services",
              primary_price: "‚Çπ10,000/month",
              secondary: "Disblay or Topiko (if needed)",
              secondary_price: "‚Çπ1,499 or ‚Çπ5,000-9,000",
              pitch: "Lead generation campaigns to get customer inquiries",
              expected_aov: "‚Çπ10,000 - ‚Çπ20,000"
            };
            marketing_push_strength = "very_high";
          }
          
          else if (data.goal_unsure === true) {
            product_recommendation = {
              primary: "GMB Setup",
              primary_price: "Free/Nominal",
              secondary: "Disblay",
              secondary_price: "‚Çπ1,499",
              pitch: "Start with basics - get on Google, then website",
              expected_aov: "‚Çπ0 - ‚Çπ5,000"
            };
            marketing_push_strength = "low";
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // STEP 5: BUSINESS TYPE MODIFIER
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          switch(data.business_type) {
            case "Retail Store":
            case "Fashion/Apparel":
            case "Jewelry":
              if (product_recommendation.primary !== "Disblay") {
                product_recommendation.alternative_disblay = {
                  product: "Disblay",
                  price: "‚Çπ1,499",
                  note: "Perfect for showcasing products"
                };
              }
              break;
              
            case "Restaurant/Cafe":
            case "Salon/Spa":
              marketing_push_strength = "high";
              product_recommendation.consultation_note = "Emphasize local visibility + Google Maps";
              break;
              
            case "B2B Services":
            case "IT/Software Services":
            case "Professional Services":
              if (product_recommendation.primary === "Disblay") {
                product_recommendation.upsell_to_topiko = {
                  product: "Topiko",
                  price: "‚Çπ5,000-9,000",
                  reason: "Professional businesses need professional website"
                };
              }
              break;
              
            case "Healthcare/Clinic":
            case "Education/Training":
              product_recommendation.consultation_note = "Emphasize trust elements + testimonials";
              break;
              
            case "Agency/Marketing":
              product_recommendation.ask_about_flex = true;
              product_recommendation.consultation_note = "Ask if they want to resell to their clients";
              break;
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // STEP 6: URGENCY MODIFIERS
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          if (urgency_score === 4) {
            marketing_push_strength = "very_high";
            product_recommendation.urgency_offer = {
              message: "Fast-start option available",
              offer: "Start this week, see results in 7-14 days"
            };
          }
          
          if (challenge_type === "optimization") {
            product_recommendation.primary = "Digital Marketing Services";
            product_recommendation.primary_price = "‚Çπ10,000/month";
            product_recommendation.secondary = "Website audit + fixes (HEBT)";
            product_recommendation.consultation_note = "Diagnose why current digital isn't working";
          }
          
          if (challenge_type === "time") {
            product_recommendation.consultation_note = "Emphasize 'we handle everything' approach";
            product_recommendation.full_service = true;
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // STEP 7: TEAM ROUTING
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          let assigned_team;
          
          if (marketing_push_strength === "very_high" || challenge_type === "optimization") {
            assigned_team = "Marketing Team";
          } else if (product_recommendation.primary && product_recommendation.primary.includes("Branding")) {
            assigned_team = "Branding Team";
          } else if (product_recommendation.ask_about_flex) {
            assigned_team = "Flex Team (but SMB Team if not interested in white-label)";
          } else {
            assigned_team = "SMB Team";
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // STEP 8: RETURN COMPLETE ROUTING
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          return {
            team: assigned_team,
            priority: priority,
            call_within: call_timing,
            primary_product: product_recommendation.primary,
            primary_price: product_recommendation.primary_price,
            secondary_product: product_recommendation.secondary || null,
            alternative_products: product_recommendation.alternative_disblay || null,
            marketing_addon_available: product_recommendation.marketing_addon,
            marketing_price: product_recommendation.marketing_price || "‚Çπ10,000/month",
            marketing_push_strength: marketing_push_strength,
            expected_aov: product_recommendation.expected_aov,
            pitch: product_recommendation.pitch,
            consultation_notes: [
              product_recommendation.consultation_note,
              product_recommendation.urgency_offer?.message,
              ...(product_recommendation.ask_about_flex ? ["Ask about white-label interest"] : [])
            ].filter(Boolean),
            crm_tags: generateCRMTags(data, urgency_score, marketing_push_strength)
          };
        }

        function generateCRMTags(data, urgency_score, marketing_push) {
          let tags = [];
          
          // Priority tags
          tags.push(`priority_${urgency_score}`);
          
          // Team routing tags
          if (data.goal_whitelabel) {
            tags.push("route_flex_team");
          } else if (data.goal_custom || data.goal_app) {
            tags.push("route_hebt_team");
          } else if (marketing_push === "very_high") {
            tags.push("route_marketing_team");
          } else if (data.goal_branding) {
            tags.push("route_branding_team");
          } else {
            tags.push("route_smb_team");
          }
          
          // Product interest tags
          if (data.goal_showcase) tags.push("interest_disblay");
          if (data.goal_website) tags.push("interest_topiko");
          if (data.goal_branding) tags.push("interest_branding");
          if (data.goal_more_customers) tags.push("interest_marketing");
          if (data.goal_app || data.goal_custom) tags.push("interest_hebt");
          if (data.goal_whitelabel) tags.push("interest_flex");
          if (data.goal_unsure) tags.push("interest_gmb");
          
          // Digital maturity tags
          tags.push(`maturity_${data.digital_presence}`);
          
          // Business segment tags
          const segment = data.business_type ? data.business_type.toLowerCase().replace(/\s+/g, '_').replace(/\//g, '_') : 'unknown';
          tags.push(`segment_${segment}`);
          
          // Marketing qualification tags
          if (marketing_push === "very_high" || marketing_push === "high") {
            tags.push("marketing_qualified");
          }
          
          // Bundle qualification tags
          if (data.goal_more_customers && data.goal_showcase) {
            tags.push("bundle_website_marketing");
          }
          if (data.goal_branding && data.goal_website) {
            tags.push("bundle_branding_website");
          }
          if (data.goal_branding && data.goal_showcase) {
            tags.push("bundle_branding_showcase");
          }
          
          // Lead quality tags
          if (urgency_score === 4 && data.goal_more_customers) {
            tags.push("quality_hot");
          } else if (urgency_score >= 3) {
            tags.push("quality_warm");
          } else {
            tags.push("quality_cold");
          }
          
          // Challenge type tags
          switch(data.challenge_urgency) {
            case "immediate_need_customers":
              tags.push("challenge_leads");
              tags.push("urgency_immediate");
              break;
            case "have_presence_no_results":
              tags.push("challenge_optimization");
              tags.push("urgency_1_3_months");
              break;
            case "exploring_dont_know":
              tags.push("challenge_awareness");
              tags.push("urgency_exploring");
              break;
            case "no_time_need_management":
              tags.push("challenge_time");
              tags.push("urgency_1_3_months");
              break;
          }
          
          // Follow-up action tags
          if (urgency_score === 4) {
            tags.push("action_call_immediate");
          } else if (urgency_score === 3) {
            tags.push("action_call_24h");
          } else {
            tags.push("action_call_48h");
            tags.push("action_add_nurture_sequence");
          }
          
          return tags;
        }

        // Data mapping function to convert form data to routing format
        function prepareRoutingData() {
            // Convert legacy fields to new format and sync both ways
            const routingData = {
                // Phone verification
                phone_number: formData.phoneNumber || formData.phone_number || '',
                phone_verified: formData.otpVerified || formData.phone_verified || false,
                
                // Basic information
                name: formData.fullName || formData.name || '',
                business_name: formData.businessName || formData.business_name || '',
                email: formData.email || '',
                business_type: formData.businessType || formData.business_type || '',
                city: formData.cityLocation || formData.city || '',
                
                // Goals - convert array to boolean flags
                goal_more_customers: (formData.goals && formData.goals.includes('need_customers')) || formData.goal_more_customers || false,
                goal_showcase: (formData.goals && formData.goals.includes('showcase_products')) || formData.goal_showcase || false,
                goal_branding: (formData.goals && formData.goals.includes('create_branding')) || formData.goal_branding || false,
                goal_website: (formData.goals && formData.goals.includes('build_website')) || formData.goal_website || false,
                goal_app: (formData.goals && formData.goals.includes('need_mobile_app')) || formData.goal_app || false,
                goal_custom: (formData.goals && formData.goals.includes('custom_solution')) || formData.goal_custom || false,
                goal_whitelabel: (formData.goals && formData.goals.includes('white_label')) || formData.goal_whitelabel || false,
                goal_unsure: (formData.goals && formData.goals.includes('not_sure')) || formData.goal_unsure || false,
                
                // Digital presence - map legacy values
                digital_presence: mapDigitalPresence(formData.digitalStatus || formData.digital_presence),
                
                // Challenge urgency - map legacy values  
                challenge_urgency: mapChallengeUrgency(formData.challenge || formData.challenge_urgency)
            };
            
            return routingData;
        }
        
        function mapDigitalPresence(value) {
            const mapping = {
                'starting_out': 'starting_out',
                'basic_presence': 'basic',
                'have_website': 'have_website', 
                'active_scale': 'active'
            };
            return mapping[value] || value;
        }
        
        function mapChallengeUrgency(value) {
            const mapping = {
                'need_customers_asap': 'immediate_need_customers',
                'improve_results': 'have_presence_no_results',
                'dont_know_start': 'exploring_dont_know',
                'no_time_manage': 'no_time_need_management'
            };
            return mapping[value] || value;
        }

        // Digital Readiness & Recommendation Engine
        async function generateResults() {
            // Use new routing logic
            const routingData = prepareRoutingData();
            const routing = routeLead(routingData);
            
            console.log('üéØ Routing Result:', routing);
            
            // Keep legacy calculation for backward compatibility
            const recommendation = getTopikkoRecommendation(formData);
            const digitalReadiness = calculateDigitalReadiness(formData);
            
            // Calculate realistic solution match using the scoring system
            const recommendedProduct = recommendation?.primary_recommendation?.product || recommendation?.product || 'Topiko';
            const solutionMatch = window.digitalReadinessScorer ? 
                window.digitalReadinessScorer.calculateSolutionMatchScore(formData, recommendedProduct) : 
                75; // Fallback to 75 if scorer not available
            
            // Create assessment in database if not already created
            if (!assessmentId) {
                await createAssessment();
            }
            
            // Update assessment with results
            await updateAssessmentResults();
            
            // Update Digital Readiness Score
            document.getElementById('digitalReadinessScore').textContent = digitalReadiness;
            
            // Update Solution Match Score  
            document.getElementById('solutionMatchScore').textContent = solutionMatch;
            
            // Update readiness label
            let readinessLabel;
            if (digitalReadiness >= 80) readinessLabel = "Digital Leader";
            else if (digitalReadiness >= 60) readinessLabel = "Growth Mode";
            else if (digitalReadiness >= 40) readinessLabel = "Digital Potential";
            else readinessLabel = "Digital Opportunity";
            document.getElementById('readinessLabel').textContent = readinessLabel;
            
            // Update solution match label
            let matchLabel;
            if (solutionMatch >= 90) matchLabel = "Perfect Match";
            else if (solutionMatch >= 80) matchLabel = "Great Match";
            else if (solutionMatch >= 70) matchLabel = "Good Match";
            else matchLabel = "Suitable Match";
            document.getElementById('matchLabel').textContent = matchLabel;
            
            // Update main title and description based on combination
            let title, description;
            if (digitalReadiness >= 60) {
                title = "Digital Growth Ready!";
                description = "Strong foundation with excellent solution match.";
            } else if (digitalReadiness >= 40) {
                title = "Great Growth Potential!";
                description = "Perfect starting point for digital transformation.";
            } else {
                title = "Digital Transformation Opportunity!";
                description = "Ideal time to build your digital presence.";
            }
            
            document.getElementById('scoreTitle').textContent = title;
            document.getElementById('scoreDescription').textContent = description;
            
            // Generate recommendations based on new routing engine
            generateRecommendationsFromRouting(routing, digitalReadiness, solutionMatch);
        }
        
        function getTopikkoRecommendation(data) {
            // Products available
            const products = {
                disblay: { name: "Disblay", price: 1499, description: "Starter showcase website", period: "year" },
                topiko_basic: { name: "Topiko Basic", price: 4999, description: "Professional Website + Android & iOS App Space + Customer Engagement", period: "year" },
                topiko_pro: { name: "Topiko Pro", price: 9999, description: "Full digital presence + CRM", period: "year" },
                marketing: { name: "Digital Marketing", price: 9999, description: "Lead generation + campaigns", period: "month" },
                brandpreneuring: { name: "Brandpreneuring", price: 999, description: "Logo + brand identity", period: "project" },
                hebt: { name: "HEBT Custom", price: 300000, description: "Custom enterprise solution", period: "project" }
            };
            
            // Hard overrides first
            const overrides = checkHardOverrides(data);
            if (overrides) {
                return {
                    primary_recommendation: {
                        product_id: overrides.product,
                        product_name: products[overrides.product].name,
                        price: products[overrides.product].price,
                        description: products[overrides.product].description,
                        confidence: overrides.confidence,
                        reason: overrides.reason
                    },
                    secondary_recommendations: overrides.secondary || [],
                    route_to: overrides.route,
                    crm_tags: generateCRMTags(data, overrides.product)
                };
            }
            
            // Scoring rules
            const scores = calculateProductScores(data);
            const topProduct = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            const confidence = Math.min(95, Math.max(60, Math.round(scores[topProduct] * 0.8))); // Reduce confidence calculation
            
            // Generate secondary recommendations
            const sortedProducts = Object.entries(scores)
                .sort(([,a], [,b]) => b - a)
                .slice(1, 3)
                .filter(([product, score]) => score > 30)
                .map(([product, score]) => ({
                    product_id: product,
                    product_name: products[product].name,
                    price: products[product].price,
                    note: getSecondaryNote(product, topProduct)
                }));
            
            return {
                primary_recommendation: {
                    product_id: topProduct,
                    product_name: products[topProduct].name,
                    price: products[topProduct].price,
                    description: products[topProduct].description,
                    confidence: confidence,
                    reason: generateReason(data, topProduct, scores)
                },
                secondary_recommendations: sortedProducts,
                route_to: getRoutingPath(topProduct, data.budget),
                crm_tags: generateCRMTags(data, topProduct)
            };
        }
        
        function checkHardOverrides(data) {
            // Custom solution override
            if (data.goals && data.goals.includes('custom_solution')) {
                return {
                    product: 'hebt',
                    confidence: 95,
                    reason: 'Custom solution requirement detected',
                    route: 'hebt_pipeline'
                };
            }
            
            // No digital + low budget
            if (data.digitalStatus === 'none' && data.budget === 'below_2k') {
                return {
                    product: 'disblay',
                    confidence: 90,
                    reason: 'Perfect starter solution for new businesses',
                    route: 'self_serve'
                };
            }
            
            // Active but no results + marketing interest
            if (data.digitalStatus === 'active_no_results' && data.goals && data.goals.includes('get_customers')) {
                return {
                    product: 'marketing',
                    confidence: 88,
                    reason: 'Need marketing to drive results from existing presence',
                    route: 'consultative_sales',
                    secondary: [{ product_id: 'topiko_basic', note: 'Foundation upgrade' }]
                };
            }
            
            // Brand help + good budget
            if ((data.brandHelp === 'yes' || data.brandHelp === 'improve') && 
                (data.budget === '10k_25k' || data.budget === '25k_plus')) {
                return {
                    product: 'brandpreneuring',
                    confidence: 85,
                    reason: 'Branding essential for business growth',
                    route: 'consultative_sales',
                    secondary: [{ product_id: 'topiko_pro', note: 'Complete digital presence' }]
                };
            }
            
            // Create website + mid budget
            if (data.goals && data.goals.includes('create_website') && data.budget === '2k_10k') {
                return {
                    product: 'topiko_basic',
                    confidence: 87,
                    reason: 'Perfect budget for professional website',
                    route: 'consultative_sales'
                };
            }
            
            return null;
        }
        
        function calculateProductScores(data) {
            const scores = {
                disblay: 25,  // Base score to avoid zero
                topiko_basic: 30,
                topiko_pro: 35,
                marketing: 20,
                brandpreneuring: 15,
                hebt: 10
            };
            
            // Goal-based scoring
            if (data.goals) {
                data.goals.forEach(goal => {
                    switch(goal) {
                        case 'showcase_products':
                            scores.disblay += 40;
                            scores.topiko_basic += 30;
                            break;
                        case 'get_customers':
                            scores.topiko_pro += 45;
                            scores.marketing += 25; // As addon service
                            break;
                        case 'build_brand':
                            scores.topiko_basic += 40;
                            scores.brandpreneuring += 25; // As addon service
                            break;
                        case 'create_website':
                            scores.topiko_basic += 45;
                            scores.disblay += 20;
                            break;
                        case 'custom_solution':
                            scores.hebt += 100;
                            break;
                    }
                });
            }
            
            // Digital status scoring
            switch(data.digitalStatus) {
                case 'none':
                    if (data.budget === 'below_2k') scores.disblay += 60;
                    else if (data.budget === '2k_10k') scores.topiko_basic += 60;
                    break;
                case 'whatsapp_only':
                    scores.disblay += 50;
                    scores.topiko_basic += 20;
                    break;
                case 'active_no_results':
                    scores.marketing += 50;
                    scores.topiko_pro += 30;
                    break;
            }
            
            // Challenge-based scoring - main products with addon services
            switch(data.challenge) {
                case 'not_getting_leads':
                    scores.topiko_pro += 50; // Main product for lead generation
                    scores.topiko_basic += 30;
                    break;
                case 'low_sales':
                    scores.topiko_pro += 45; // Main product with branding addon
                    scores.topiko_basic += 35;
                    break;
                case 'dont_know_start':
                    scores.topiko_basic += 50; // Perfect starting product
                    scores.disblay += 25;
                    break;
                case 'no_time':
                    scores.topiko_pro += 60; // Managed solution
                    break;
            }
            
            // Brand help scoring - integrate with main products
            if (data.brandHelp === 'yes' || data.brandHelp === 'improve') {
                scores.topiko_basic += 40; // Main product includes branding
                scores.topiko_pro += 30;
            }
            
            // Budget modifiers
            if (data.budget === '25k_plus') {
                scores.hebt += 50;
            }
            
            // Timeline modifiers
            if (data.timeline === 'immediate' && data.budget === '2k_10k') {
                scores.topiko_basic += 30;
                scores.marketing += 20;
            }
            
            return scores;
        }
        
        function generateReason(data, topProduct, scores) {
            let reason = "";
            
            // Goal-based reasoning
            if (data.goals && data.goals.length > 0) {
                const goalReasons = {
                    'get_customers': 'helps drive customer acquisition',
                    'showcase_products': 'perfectly showcases your products/services',
                    'build_brand': 'strengthens your brand presence',
                    'create_website': 'gives you a professional website',
                    'manage_customers': 'includes customer management tools'
                };
                
                const goalTexts = data.goals.map(goal => goalReasons[goal]).filter(Boolean);
                if (goalTexts.length > 0) {
                    reason += `This solution ${goalTexts.join(' and ')}. `;
                }
            }
            
            // Budget and business type reasoning
            const businessType = data.businessType || 'business';
            const productReasons = {
                disblay: `Perfect starter solution for your ${businessType}`,
                topiko_basic: `Professional website ideal for ${businessType} businesses`,
                topiko_pro: `Complete digital presence to grow your ${businessType}`,
                marketing: `Lead generation focused solution`,
                brandpreneuring: `Strong branding foundation`,
                hebt: `Custom solution for unique requirements`
            };
            
            reason += productReasons[topProduct] || 'Best match for your needs';
            
            // Budget-based reasoning
            if (data.budget) {
                const budgetReasons = {
                    'below_2k': ' that fits your budget perfectly.',
                    '2k_10k': ' with excellent value in your budget range.',
                    '10k_25k': ' allowing for comprehensive features.',
                    '25k_plus': ' with premium capabilities.'
                };
                reason += budgetReasons[data.budget] || '.';
            } else {
                reason += '.';
            }
            
            return reason;
        }
        
        function getSecondaryNote(product, primary) {
            const notes = {
                disblay: "Great starting point",
                topiko_basic: "Professional foundation",
                topiko_pro: "Complete solution",
                marketing: "Drive more leads", 
                brandpreneuring: "Build strong brand",
                hebt: "Custom development"
            };
            return notes[product] || "Recommended addition";
        }
        
        function getRoutingPath(product, budget) {
            if (product === 'hebt') return 'hebt_pipeline';
            if (product === 'disblay' && budget === 'below_2k') return 'self_serve';
            return 'consultative_sales';
        }
        
        function generateCRMTags(data, product) {
            const tags = [
                `${product}_lead`,
                `budget_${data.budget}`,
                `digital_${data.digitalStatus}`,
                `${data.businessType}_business`
            ];
            
            if (data.timeline === 'immediate') tags.push('urgent_timeline');
            if (data.goals && data.goals.includes('get_customers')) tags.push('wants_customers');
            if (data.brandHelp === 'yes') tags.push('needs_branding');
            
            return tags;
        }

        function calculateDigitalReadiness(data) {
            let readinessScore = 0;
            
            // Base digital presence assessment (40% of score)
            switch(data.digitalStatus) {
                case 'none':
                    readinessScore += 15; // Starting from scratch
                    break;
                case 'whatsapp_only':
                    readinessScore += 30; // Basic communication tool
                    break;
                case 'basic_website':
                    readinessScore += 50; // Has online presence
                    break;
                case 'social_only':
                    readinessScore += 40; // Active on social but missing website
                    break;
                case 'full_website_no_results':
                    readinessScore += 55; // Has website but needs optimization
                    break;
                case 'active_no_results':
                    readinessScore += 60; // Active but needs improvement
                    break;
            }
            
            // Goals clarity and ambition (20% of score)
            if (data.goals && data.goals.length > 0) {
                const goalPoints = Math.min(20, data.goals.length * 5); // 5 points per goal, max 20
                readinessScore += goalPoints;
            }
            
            // Investment readiness (20% of score)
            switch(data.budget) {
                case 'nothing':
                    readinessScore += 5;
                    break;
                case 'below_2k':
                    readinessScore += 10;
                    break;
                case '2k_10k':
                    readinessScore += 15;
                    break;
                case '10k_25k':
                    readinessScore += 18;
                    break;
                case '25k_plus':
                    readinessScore += 20;
                    break;
            }
            
            // Timeline urgency (10% of score)
            switch(data.timeline) {
                case 'immediately':
                    readinessScore += 10;
                    break;
                case '1_3_months':
                    readinessScore += 8;
                    break;
                case '3_6_months':
                    readinessScore += 6;
                    break;
                case 'exploring':
                    readinessScore += 3;
                    break;
            }
            
            // Management readiness (10% of score)
            switch(data.managedBy) {
                case 'nobody':
                    readinessScore += 3; // Needs help
                    break;
                case 'myself':
                    readinessScore += 6;
                    break;
                case 'family':
                    readinessScore += 5;
                    break;
                case 'employee':
                    readinessScore += 8;
                    break;
                case 'agency':
                    readinessScore += 10; // Already has digital help
                    break;
            }
            
            // Ensure score is within 0-100 range
            return Math.min(100, Math.max(0, Math.round(readinessScore)));
        }
        
        function generateRecommendationsFromRouting(routing, digitalReadiness, solutionMatch) {
            const firstName = formData.fullName ? formData.fullName.split(' ')[0] : 'there';
            
            // Populate primary recommendation card
            populatePrimaryCard(routing);
            
            // Show/hide and populate marketing card
            populateMarketingCard(routing);
            
            // Show/hide and populate bundle card if applicable
            populateBundleCard(routing);
            
            // Populate consultation preview
            populateConsultationPreview(routing, firstName);
            
            // Update consultation button with urgency
            updateConsultationButton(routing);
            
            // Log routing details for debugging
            console.log('üéØ Routing Result:', routing);
            console.log('üè∑Ô∏è CRM Tags:', routing.crm_tags);
            console.log('üë• Team Assignment:', routing.team);
            console.log('‚ö° Priority:', routing.priority, '- Call within:', routing.call_within);
        }

        function populatePrimaryCard(routing) {
            // Update product name
            document.getElementById('primaryProductName').textContent = routing.primary_product || 'Recommended Solution';
            
            // Update pricing
            document.getElementById('primaryPricing').textContent = 
                routing.primary_price ? `Just ${routing.primary_price}` : 'Pricing discussed in consultation';
            
            // Update features based on product
            const featuresElement = document.getElementById('primaryFeatures');
            const features = getProductFeatures(routing.primary_product);
            featuresElement.innerHTML = features.map(feature => 
                `<div class="feature-item">‚úì ${feature}</div>`
            ).join('');
        }

        function populateMarketingCard(routing) {
            const marketingCard = document.getElementById('marketingRecommendation');
            
            if (routing.marketing_addon_available) {
                marketingCard.style.display = 'block';
                
                // Update title based on push strength
                const titleElement = document.querySelector('.marketing-title');
                const titles = {
                    "very_high": "Want Customers Immediately?",
                    "high": "Want More Customer Inquiries?",
                    "medium": "Want Customer Inquiries Too?",
                    "low": "Consider Adding Marketing Later"
                };
                titleElement.textContent = titles[routing.marketing_push_strength] || "Add Digital Marketing";
                
                // Update pricing
                document.getElementById('marketingPrice').textContent = 
                    `Starting from ${routing.marketing_price}`;
                
                // Add visual emphasis for high urgency
                if (routing.marketing_push_strength === 'very_high') {
                    marketingCard.style.border = '2px solid #fbbf24';
                    marketingCard.style.background = 'rgba(251, 191, 36, 0.1)';
                    marketingCard.style.animation = 'pulse 2s infinite';
                } else if (routing.marketing_push_strength === 'high') {
                    marketingCard.style.border = '1px solid #fbbf24';
                    marketingCard.style.background = 'rgba(251, 191, 36, 0.05)';
                }
            } else {
                marketingCard.style.display = 'none';
            }
        }

        function populateBundleCard(routing) {
            const bundleCard = document.getElementById('bundleRecommendation');
            
            // Show bundle card for branding combinations or alternatives
            if (shouldShowBundle(routing)) {
                bundleCard.style.display = 'block';
                
                const bundleContent = document.getElementById('bundleContent');
                bundleContent.innerHTML = generateBundleContent(routing);
            } else {
                bundleCard.style.display = 'none';
            }
        }

        function shouldShowBundle(routing) {
            // Show bundle for branding combinations or when there are alternatives
            const routingData = prepareRoutingData();
            return (routingData.goal_branding && routingData.goal_website) ||
                   (routingData.goal_branding && routingData.goal_showcase) ||
                   routing.alternative_products;
        }

        function generateBundleContent(routing) {
            const routingData = prepareRoutingData();
            
            if (routingData.goal_branding && routingData.goal_website) {
                return `
                    <div class="bundle-item">
                        <div style="font-weight: 600; margin-bottom: 8px;">Professional Digital Presence</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 12px;">
                            ‚Ä¢ Topiko Website (‚Çπ5,000-9,000)<br>
                            ‚Ä¢ Professional Branding (‚Çπ8,000)<br>
                            ‚Ä¢ Complete brand identity package
                        </div>
                        <div style="font-weight: 600; color: #4ade80;">Total: ‚Çπ13,000 - ‚Çπ17,000</div>
                    </div>
                `;
            } else if (routingData.goal_branding && routingData.goal_showcase) {
                return `
                    <div class="bundle-item">
                        <div style="font-weight: 600; margin-bottom: 8px;">Brand + Showcase Package</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 12px;">
                            ‚Ä¢ Disblay Website (‚Çπ1,499)<br>
                            ‚Ä¢ Professional Branding (‚Çπ8,000)<br>
                            ‚Ä¢ Logo & brand assets
                        </div>
                        <div style="font-weight: 600; color: #4ade80;">Total: ‚Çπ9,499</div>
                    </div>
                `;
            } else if (routing.alternative_products) {
                return `
                    <div class="bundle-item">
                        <div style="font-weight: 600; margin-bottom: 8px;">Alternative Option</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 12px;">
                            ${routing.alternative_products.product}: ${routing.alternative_products.note}
                        </div>
                        <div style="font-weight: 600; color: #4ade80;">${routing.alternative_products.price}</div>
                    </div>
                `;
            }
            
            return '<div>Multiple solution options available</div>';
        }

        function populateConsultationPreview(routing, firstName) {
            const customItem = document.getElementById('customPreviewItem');
            const notes = routing.consultation_notes.filter(note => note && note.trim());
            
            if (notes.length > 0) {
                customItem.textContent = `‚Ä¢ ${notes[0]}`;
                customItem.style.display = 'block';
            } else {
                customItem.style.display = 'none';
            }
        }

        function getProductFeatures(product_name) {
            const features_map = {
                "Disblay": [
                    "Product showcase website",
                    "WhatsApp-friendly links",
                    "Payment & shipping integration",
                    "Mobile-first design",
                    "Easy to update yourself"
                ],
                "Topiko": [
                    "Custom domain & professional design",
                    "Payment & shipping integration",
                    "Multiple themes & layouts",
                    "Ongoing maintenance included",
                    "Priority support"
                ],
                "Topiko + Brandpreneuring": [
                    "Professional website with custom domain",
                    "Complete brand identity package",
                    "Logo design & brand assets",
                    "Social media templates",
                    "Priority support"
                ],
                "Disblay + Brandpreneuring": [
                    "Product showcase website",
                    "Professional logo & branding",
                    "Brand identity guidelines",
                    "Social media assets",
                    "WhatsApp-ready links"
                ],
                "Brandpreneuring": [
                    "Professional logo design",
                    "Brand identity & guidelines",
                    "Social media assets",
                    "Business card design",
                    "Brand consultation"
                ],
                "Digital Marketing Services": [
                    "Social media management",
                    "Google/Facebook ad campaigns",
                    "Lead generation strategies",
                    "Monthly performance reports",
                    "Month-to-month, no lock-in"
                ],
                "GMB Setup": [
                    "Google My Business profile setup",
                    "Basic business information",
                    "Location & hours setup",
                    "Free/Nominal pricing",
                    "Foundation for digital presence"
                ],
                "HEBT Custom Development": [
                    "Custom website/app development",
                    "Tailored to your requirements",
                    "Scalable architecture",
                    "Ongoing technical support",
                    "Project-based pricing"
                ],
                "Flex White-Label Platform": [
                    "Sell under your brand",
                    "Complete white-label solution",
                    "Technical support included",
                    "Partner dashboard access",
                    "Custom pricing discussion"
                ]
            };
            
            return features_map[product_name] || [
                "Custom solution for your needs",
                "Professional implementation",
                "Ongoing support",
                "Flexible pricing"
            ];
        }
        
        function createProductCard(routing, type, digitalReadiness) {
            const isMarketing = routing.primary_product?.includes('Marketing');
            const productName = routing.primary_product;
            const price = routing.primary_price;
            const pitch = routing.pitch || 'Perfect solution for your business needs';
            
            // Create contextual message based on digital readiness
            let context = "";
            if (digitalReadiness < 40) {
                context = "Perfect starting point for your digital journey! ";
            } else if (digitalReadiness < 60) {
                context = "Great foundation to build upon! ";
            } else {
                context = "Excellent choice to accelerate your growth! ";
            }
            
            return `
                <div style="text-align: left; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.2); border-radius: 16px; padding: 20px; background: rgba(255,255,255,0.05);">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: #667eea;">
                        üíé ${productName}
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 12px;">
                        ${pitch}
                    </div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #4ade80;">
                        ${price}
                    </div>
                    <div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 12px; font-style: italic;">
                        ${context}Based on your goals and current setup.
                    </div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                        Expected value: ${routing.expected_aov || 'Discuss in consultation'}
                    </div>
                </div>
            `;
        }
        
        function createMarketingCard(routing) {
            const pushStrength = routing.marketing_push_strength;
            let title = "üì¢ Add Digital Marketing";
            let emphasis = "";
            
            if (pushStrength === "very_high") {
                title = "‚ö° Want Customers Immediately?";
                emphasis = "style='border: 2px solid #fbbf24; background: rgba(251, 191, 36, 0.1); animation: pulse 2s infinite;'";
            } else if (pushStrength === "high") {
                title = "üì¢ Want More Customer Inquiries?";
                emphasis = "style='border: 2px solid #60a5fa; background: rgba(96, 165, 250, 0.1);'";
            }
            
            return `
                <div ${emphasis} style="text-align: left; margin-bottom: 20px; border-radius: 16px; padding: 20px; background: rgba(255,255,255,0.05);">
                    <div style="font-size: 17px; font-weight: 700; margin-bottom: 8px; color: #fbbf24;">
                        ${title}
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 12px;">
                        Social media campaigns, Google/Facebook ads, Lead generation
                    </div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #4ade80;">
                        ${routing.marketing_price}
                    </div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                        Month-to-month, no lock-in ‚Ä¢ Discuss in consultation
                    </div>
                </div>
            `;
        }
        
        function createAlternativeCard(alternative) {
            return `
                <div style="text-align: left; margin-bottom: 20px; border: 1px dashed rgba(255,255,255,0.3); border-radius: 16px; padding: 20px; background: rgba(255,255,255,0.02);">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #a78bfa;">
                        üîÑ Alternative: ${alternative.product}
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                        ${alternative.note}
                    </div>
                    <div style="font-size: 14px; font-weight: 600; color: #4ade80;">
                        ${alternative.price}
                    </div>
                </div>
            `;
        }
        
        function createConsultationPreview(routing, firstName) {
            const notes = routing.consultation_notes.filter(note => note && note.trim());
            const notesHtml = notes.length > 0 ? 
                `<div style="margin-top: 12px;">
                    ${notes.map(note => `<div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">‚Ä¢ ${note}</div>`).join('')}
                </div>` : '';
            
            return `
                <div style="text-align: left; margin-bottom: 20px; border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 16px; padding: 20px; background: rgba(102, 126, 234, 0.05);">
                    <div style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #667eea;">
                        üìû In your 10-minute consultation:
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                        ‚Ä¢ See ${routing.primary_product} with your business
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                        ‚Ä¢ View 2-3 examples from your industry
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                        ‚Ä¢ Get exact pricing & timeline
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                        ‚Ä¢ Try free for 7 days if unsure
                    </div>
                    ${notesHtml}
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 12px; font-style: italic;">
                        Quick call. No pressure. Just showing you what's possible.
                    </div>
                </div>
            `;
        }
        
        function updateConsultationButton(routing) {
            const consultBtn = document.getElementById('consultationBtn');
            if (consultBtn) {
                if (routing.priority === 1) {
                    consultBtn.innerHTML = '‚ö° Book Same-Day Call';
                    consultBtn.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
                    consultBtn.style.animation = 'pulse 2s infinite';
                } else if (routing.priority === 2) {
                    consultBtn.innerHTML = 'üìÖ Book Tomorrow Call';
                    consultBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                } else {
                    consultBtn.innerHTML = 'üìû Book 10-Min Consultation';
                    consultBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                }
            }
        }
        
        function generateRecommendations(recommendation, digitalReadiness, solutionMatch) {
            const firstName = formData.fullName.split(' ')[0];
            const primary = recommendation.primary_recommendation;
            // solutionMatch is now passed as parameter
            
            // Get product details for pricing
            const products = {
                disblay: { name: "Disblay", price: 1499, period: "year" },
                topiko_basic: { name: "Topiko Basic", price: 4999, period: "year" },
                topiko_pro: { name: "Topiko Pro", price: 9999, period: "year" },
                marketing: { name: "Digital Marketing", price: 9999, period: "month" },
                brandpreneuring: { name: "Brandpreneuring", price: 999, period: "project" },
                hebt: { name: "HEBT Custom", price: 300000, period: "project" }
            };
            
            const productInfo = products[primary.product_id] || products['topiko_basic'];
            let priceText;
            
            // Special handling for HEBT - show custom message instead of price
            if (primary.product_id === 'hebt') {
                priceText = 'Our team will reach out for personalized solution preparation';
            } else {
                priceText = productInfo.period === 'project' ? 
                    `Starts from ‚Çπ${productInfo.price.toLocaleString()}` :
                    `Starts from ‚Çπ${productInfo.price.toLocaleString()}/${productInfo.period}`;
            }
            
            // Create contextual recommendation message based on digital readiness
            let recommendationContext = "";
            if (digitalReadiness < 40) {
                recommendationContext = "Perfect starting point for your digital journey! ";
            } else if (digitalReadiness < 60) {
                recommendationContext = "Great foundation to build upon! ";
            } else {
                recommendationContext = "Excellent choice to accelerate your growth! ";
            }
            
            let recommendations = `
                <div style="text-align: left; margin-bottom: 20px;">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: #667eea;">
                        üíé ${primary.product_name || productInfo.name}
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 12px;">
                        ${primary.description}
                    </div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">
                        ${priceText}
                    </div>
                    <div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 12px; font-style: italic;">
                        "${recommendationContext}${primary.reason}"
                    </div>
                    <div style="font-size: 12px; color: rgba(102, 126, 234, 0.8); margin-bottom: 16px;">
                        Solution Match: ${solutionMatch}% confidence
                    </div>
            `;
            
            // Add secondary recommendations if available
            if (recommendation.secondary_recommendations && recommendation.secondary_recommendations.length > 0) {
                recommendations += '<div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Also Consider:</div>';
                recommendation.secondary_recommendations.forEach(sec => {
                    recommendations += `
                        <div style="background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px;">${sec.product_name}</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">${sec.note} - ‚Çπ${sec.price.toLocaleString()}</div>
                        </div>
                    `;
                });
            }
            
            // Add routing information for internal use (hidden)
            recommendations += `
                </div>
                <div style="display: none;" id="recommendationData">
                    ${JSON.stringify({
                        primary: primary,
                        secondary: recommendation.secondary_recommendations,
                        route: recommendation.route_to,
                        tags: recommendation.crm_tags,
                        confidence: primary.confidence
                    })}
                </div>
            `;
            
            document.getElementById('recommendationContent').innerHTML = recommendations;
            
            // Update final chat message with confidence-based messaging
            let chatMessage;
            if (primary.confidence >= 85) {
                chatMessage = `üéØ ${firstName}, I'm highly confident this is perfect for ${formData.businessName}! ${primary.product_name} matches your needs exactly.`;
            } else if (primary.confidence >= 70) {
                chatMessage = `üéâ ${firstName}, great news! ${primary.product_name} is an excellent fit for ${formData.businessName}'s goals.`;
            } else {
                chatMessage = `üöÄ ${firstName}, ${primary.product_name} is a solid starting point for ${formData.businessName}'s digital journey!`;
            }
            
            document.getElementById('chatMessage3').textContent = chatMessage;
        }
        
        // Professional Audit Functions
        function startDetailedAudit() {
            // Get the actual recommendation first
            const recommendation = getTopikkoRecommendation(formData);
            recommendedProduct = recommendation.primary_recommendation.product_id;
            
            // Select audit questions based PRIMARILY on the recommendation
            auditQuestions = selectAuditQuestionsForProduct(recommendedProduct, formData);
            
            currentAuditIndex = 0;
            auditData = {};
            
            // Show audit screen
            document.getElementById('screen3').classList.remove('active');
            document.getElementById('screen4').classList.add('active');
            
            loadAuditQuestion();
        }
        
        function selectAuditQuestionsForProduct(recommendedProduct, formData) {
            let selectedQuestions = [];
            
            switch(recommendedProduct) {
                case 'disblay':
                    selectedQuestions = getDisblayAuditQuestions(formData);
                    break;
                case 'topiko_basic':
                    selectedQuestions = getTopikoBasicAuditQuestions(formData);
                    break;
                case 'topiko_pro':
                    selectedQuestions = getTopikoProAuditQuestions(formData);
                    break;
                case 'marketing':
                    selectedQuestions = getMarketingAuditQuestions(formData);
                    break;
                case 'brandpreneuring':
                    selectedQuestions = getBrandingAuditQuestions(formData);
                    break;
                case 'hebt':
                    selectedQuestions = getHEBTAuditQuestions(formData);
                    break;
                default:
                    // Fallback to website questions for unknown products
                    selectedQuestions = getTopikoBasicAuditQuestions(formData);
            }
            
            return selectedQuestions.slice(0, 8); // Limit to 8 questions max
        }
        
        function getDisblayAuditQuestions(formData) {
            const questions = [
                {
                    id: 'domain',
                    question: 'Do you own a domain name for your business?',
                    explanation: 'Disblay needs a domain to showcase your business. We can help you choose and register the perfect domain.',
                    category: 'Technical Setup'
                },
                {
                    id: 'content_photos',
                    question: 'Do you have professional photos of your products/services?',
                    explanation: 'Disblay is a showcase website. High-quality visuals are essential for creating a compelling first impression.',
                    category: 'Content Readiness'
                },
                {
                    id: 'business_info',
                    question: 'Do you have your business description and contact details ready?',
                    explanation: 'Clear business information helps visitors understand your value proposition quickly.',
                    category: 'Content Readiness'
                },
                {
                    id: 'mobile_visitors',
                    question: 'Do most of your customers find you through mobile searches?',
                    explanation: 'Disblay is mobile-first designed. Understanding your customer behavior helps optimize the experience.',
                    category: 'User Experience'
                },
                {
                    id: 'future_growth',
                    question: 'Are you planning to add online payments or advanced features later?',
                    explanation: 'Disblay can be upgraded to Topiko. Knowing your growth plans helps us prepare the foundation.',
                    category: 'Growth Planning'
                }
            ];
            
            return questions;
        }
        
        function getTopikoBasicAuditQuestions(formData) {
            const questions = [
                {
                    id: 'domain',
                    question: 'Do you own a domain name for your business?',
                    explanation: 'Topiko Basic includes domain setup. We can help you choose and register the perfect domain.',
                    category: 'Technical Setup'
                },
                {
                    id: 'content_photos',
                    question: 'Do you have professional photos of your products/services?',
                    explanation: 'High-quality visuals increase customer trust and conversion rates by 40%.',
                    category: 'Content Readiness'
                },
                {
                    id: 'business_info',
                    question: 'Do you have your business description, services list, and contact details ready?',
                    explanation: 'Well-structured content helps customers understand your value and improves search rankings.',
                    category: 'Content Readiness'
                },
                {
                    id: 'online_payments',
                    question: 'Do you need to accept payments online?',
                    explanation: 'Topiko Basic can integrate payment gateways to enable 24/7 sales.',
                    category: 'Business Operations'
                },
                {
                    id: 'customer_inquiries',
                    question: 'How do customers currently contact you for inquiries?',
                    explanation: 'Topiko includes customer engagement tools to streamline communication.',
                    category: 'Customer Management'
                }
            ];
            
            return questions;
        }
        
        function getTopikoProAuditQuestions(formData) {
            let questions = [
                {
                    id: 'domain',
                    question: 'Do you own a domain name for your business?',
                    explanation: 'Topiko Pro includes professional domain setup and management.',
                    category: 'Technical Setup'
                },
                {
                    id: 'business_tools',
                    question: 'Do you currently use any business management tools (accounting, inventory, etc.)?',
                    explanation: 'Topiko Pro can integrate with existing tools to provide unified business management.',
                    category: 'Business Integration'
                },
                {
                    id: 'customer_database',
                    question: 'Do you have a system to track customer information and interactions?',
                    explanation: 'Topiko Pro includes advanced CRM capabilities to manage your customer relationships.',
                    category: 'Customer Management'
                },
                {
                    id: 'analytics_needs',
                    question: 'Do you need detailed insights about your website visitors and sales?',
                    explanation: 'Topiko Pro includes comprehensive analytics and reporting tools.',
                    category: 'Analytics & Insights'
                }
            ];
            
            // Context-aware refinement based on business size and needs
            if (formData.challenge === 'no_time') {
                questions.push({
                    id: 'automation_priority',
                    question: 'Which repetitive tasks take up most of your time?',
                    explanation: 'Topiko Pro can automate many routine tasks to free up your time for strategic work.',
                    category: 'Time Management'
                });
            } else {
                questions.push({
                    id: 'team_access',
                    question: 'Do multiple team members need access to manage your online presence?',
                    explanation: 'Topiko Pro supports multi-user access with role-based permissions.',
                    category: 'Team Management'
                });
            }
            
            // Add scalability question for growing businesses
            if (formData.budget === '10k_25k' || formData.budget === '25k_plus') {
                questions.push({
                    id: 'scalability_plans',
                    question: 'Are you planning to scale your business operations in the next 1-2 years?',
                    explanation: 'Topiko Pro is designed to grow with your business and handle increased demand.',
                    category: 'Growth Planning'
                });
            }
            
            return questions.slice(0, 6); // Keep focused with 6 questions
        }
        
        function getMarketingAuditQuestions(formData) {
            let questions = [
                {
                    id: 'current_marketing',
                    question: 'What marketing channels do you currently use?',
                    explanation: 'Understanding your current efforts helps us optimize and expand your marketing strategy.',
                    category: 'Current Strategy'
                },
                {
                    id: 'lead_tracking',
                    question: 'Do you currently track where your customers come from?',
                    explanation: 'Lead tracking is essential for measuring campaign effectiveness and ROI.',
                    category: 'Lead Management'
                },
                {
                    id: 'target_audience',
                    question: 'Do you have a clear understanding of your ideal customers?',
                    explanation: 'Defined target audience helps create focused campaigns with 3x better results.',
                    category: 'Audience Strategy'
                },
                {
                    id: 'marketing_content',
                    question: 'Do you have marketing content like videos, testimonials, or case studies?',
                    explanation: 'Quality content is the foundation of effective digital marketing campaigns.',
                    category: 'Content Marketing'
                },
                {
                    id: 'ad_budget',
                    question: 'Are you prepared to invest in paid advertising (Google Ads, Facebook Ads)?',
                    explanation: 'Paid advertising provides immediate visibility and typically generates 4-8x return on investment.',
                    category: 'Advertising Investment'
                }
            ];
            
            // Context-aware refinement based on user challenges and goals
            if (formData.challenge === 'not_getting_leads') {
                questions.push({
                    id: 'lead_generation_strategy',
                    question: 'What strategies have you tried to generate more leads?',
                    explanation: 'Understanding what you\'ve tried helps us avoid repeating ineffective approaches.',
                    category: 'Lead Generation Focus'
                });
            }
            
            if (formData.challenge === 'no_time') {
                questions.push({
                    id: 'campaign_management',
                    question: 'Would you prefer fully managed campaigns or training to do it yourself?',
                    explanation: 'We offer both managed services and training programs to fit your time availability.',
                    category: 'Service Preference'
                });
            } else {
                questions.push({
                    id: 'campaign_involvement',
                    question: 'Do you want to be involved in campaign strategy and optimization?',
                    explanation: 'Some clients prefer hands-on involvement while others want complete delegation.',
                    category: 'Campaign Management'
                });
            }
            
            return questions.slice(0, 6); // Keep focused with 6 questions
        }
        
        function getBrandingAuditQuestions(formData) {
            let questions = [
                {
                    id: 'current_branding',
                    question: 'Do you have any existing brand assets (logo, colors, fonts)?',
                    explanation: 'We can work with existing elements or create a completely fresh brand identity.',
                    category: 'Brand Assets'
                },
                {
                    id: 'brand_personality',
                    question: 'How would you describe your brand personality (professional, friendly, innovative, etc.)?',
                    explanation: 'Brand personality guides all design decisions and messaging strategies.',
                    category: 'Brand Strategy'
                },
                {
                    id: 'competitor_awareness',
                    question: 'Are you familiar with how your competitors present themselves?',
                    explanation: 'Competitive analysis helps position your brand uniquely in the market.',
                    category: 'Market Positioning'
                },
                {
                    id: 'marketing_materials',
                    question: 'Do you need brand guidelines for consistent marketing materials?',
                    explanation: 'Brand guidelines ensure consistent presentation across all platforms, increasing recognition by 60%.',
                    category: 'Brand Consistency'
                }
            ];
            
            // Context-aware refinement based on business type and brand status
            if (['retail', 'food'].includes(formData.businessType)) {
                questions.push({
                    id: 'visual_appeal',
                    question: 'How important is visual appeal for attracting your customers?',
                    explanation: 'Visual businesses need strong visual branding to stand out and attract customers.',
                    category: 'Visual Impact'
                });
            }
            
            if (formData.brandHelp === 'improve') {
                questions.push({
                    id: 'brand_issues',
                    question: 'What aspects of your current branding would you like to improve?',
                    explanation: 'Understanding specific concerns helps us focus on the right improvements.',
                    category: 'Brand Improvement'
                });
            } else if (formData.brandHelp === 'yes') {
                questions.push({
                    id: 'brand_vision',
                    question: 'Do you have a vision for how you want your brand to be perceived?',
                    explanation: 'Your brand vision guides all creative decisions and positioning strategies.',
                    category: 'Brand Vision'
                });
            }
            
            return questions.slice(0, 5); // Keep focused with 5 questions
        }
        
        function getHEBTAuditQuestions(formData) {
            const questions = [
                {
                    id: 'custom_requirements',
                    question: 'Do you have specific technical requirements or integrations needed?',
                    explanation: 'Custom solutions require detailed requirement analysis to ensure perfect fit.',
                    category: 'Technical Requirements'
                },
                {
                    id: 'project_scope',
                    question: 'Have you defined the scope and objectives of your custom solution?',
                    explanation: 'Clear project scope helps us deliver exactly what you need within timeline and budget.',
                    category: 'Project Planning'
                },
                {
                    id: 'scalability_needs',
                    question: 'Do you need the solution to handle growth and increased usage?',
                    explanation: 'Scalable architecture prevents future bottlenecks and reduces long-term costs.',
                    category: 'Scalability'
                },
                {
                    id: 'timeline_flexibility',
                    question: 'Do you have flexibility in project timeline for optimal development?',
                    explanation: 'Realistic timelines ensure quality delivery without compromising on features.',
                    category: 'Timeline Management'
                },
                {
                    id: 'team_involvement',
                    question: 'Will your team be actively involved in the development process?',
                    explanation: 'Collaborative development ensures the solution perfectly matches your workflow.',
                    category: 'Team Collaboration'
                }
            ];
            
            return questions;
        }
        
        // Legacy function - no longer needed with focused question sets
        // Questions are now pre-prioritized within each product category
        
        function loadAuditQuestion() {
            if (currentAuditIndex >= auditQuestions.length) {
                completeAudit();
                return;
            }
            
            const question = auditQuestions[currentAuditIndex];
            const progressPercent = ((currentAuditIndex + 1) / auditQuestions.length) * 100;
            
            // Update progress bar
            document.getElementById('auditProgressFill').style.width = `${progressPercent}%`;
            
            // Update question content
            document.getElementById('auditQuestionNumber').textContent = currentAuditIndex + 1;
            document.getElementById('auditCategory').textContent = question.category;
            document.getElementById('auditQuestion').textContent = question.question;
            document.getElementById('auditExplanation').textContent = question.explanation;
            document.getElementById('auditNavInfo').textContent = `Question ${currentAuditIndex + 1} of ${auditQuestions.length}`;
            
            // Clear previous selections
            document.querySelectorAll('.audit-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Disable next button until answer is selected
            document.getElementById('auditNextBtn').disabled = true;
            
            // Update button text for last question
            const nextBtn = document.getElementById('auditNextBtn');
            if (currentAuditIndex === auditQuestions.length - 1) {
                nextBtn.textContent = 'Complete Audit';
                nextBtn.onclick = completeAudit;
            } else {
                nextBtn.textContent = 'Next Question';
                nextBtn.onclick = nextAuditQuestion;
            }
        }
        
        function handleAuditAnswer(answer) {
            const question = auditQuestions[currentAuditIndex];
            auditData[question.id] = {
                answer: answer,
                question: question.question,
                category: question.category
            };
            
            // Mark selected option
            document.querySelectorAll('.audit-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.value === answer) {
                    option.classList.add('selected');
                }
            });
            
            // Enable next button
            document.getElementById('auditNextBtn').disabled = false;
        }
        
        function nextAuditQuestion() {
            if (currentAuditIndex < auditQuestions.length - 1) {
                currentAuditIndex++;
                loadAuditQuestion();
            }
        }
        
        function previousAuditQuestion() {
            if (currentAuditIndex > 0) {
                currentAuditIndex--;
                loadAuditQuestion();
            }
        }
        
        async function completeAudit() {
            // Save audit data to database
            await saveAuditData();
            
            // Generate detailed plan based on audit responses
            generateDetailedPlan();
            
            // Show detailed plan screen
            document.getElementById('screen4').classList.remove('active');
            document.getElementById('screen5').classList.add('active');
        }
        
        function generateDetailedPlan() {
            const firstName = formData.fullName.split(' ')[0];
            const recommendation = getTopikkoRecommendation(formData);
            const digitalReadiness = calculateDigitalReadiness(formData);
            
            // Analyze audit responses
            const readinessScore = calculateImplementationReadiness();
            const priorities = generateActionPriorities();
            const roadmap = generateImplementationRoadmap();
            const riskFactors = identifyRiskFactors();
            const successMetrics = generateSuccessMetrics();
            const costBreakdown = generateCostBreakdown(recommendation);
            const timeline = generateProjectTimeline();
            
            let planHTML = `
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üìä Executive Summary</h3>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <p style="font-size: 14px; line-height: 1.5; color: rgba(255,255,255,0.9); margin: 0;">
                            Hello ${firstName}! Based on your comprehensive assessment, here's your personalized digital transformation roadmap. 
                            Your implementation readiness score is <strong style="color: #667eea;">${readinessScore}%</strong>.
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Digital Readiness</div>
                            <div style="font-size: 18px; font-weight: 700; color: #667eea;">${digitalReadiness}%</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Recommended Product</div>
                            <div style="font-size: 14px; font-weight: 600; color: #f093fb;">${getProductDisplayName(recommendation.primary_recommendation.product_id)}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üéØ Priority Action Items</h3>
                    ${priorities}
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üí∞ Investment Breakdown</h3>
                    ${costBreakdown}
                </div>
                
                <!-- Implementation Timeline section commented out
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üìÖ Implementation Timeline</h3>
                    ${timeline}
                </div>
                -->
                
                <!-- Success Metrics section commented out
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üéØ Success Metrics</h3>
                    ${successMetrics}
                </div>
                -->
                
                ${riskFactors ? `
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #f5576c; margin-bottom: 12px;">‚ö†Ô∏è Risk Mitigation</h3>
                    ${riskFactors}
                </div>
                ` : ''}
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üìã Detailed Implementation Roadmap</h3>
                    ${roadmap}
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">üöÄ Next Steps</h3>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 16px; border-radius: 12px; border-left: 4px solid #667eea;">
                        <div style="font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.9);">
                            <div style="margin-bottom: 12px;"><strong>Immediate Actions:</strong></div>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>Our expert will call you within 2 hours to discuss this plan</li>
                                <li>Free 30-minute strategy consultation to refine requirements</li>
                                <li>Customized proposal with exact pricing and timeline</li>
                                <li>Optional: Free competitor analysis report</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detailedPlanContent').innerHTML = planHTML;
        }
        
        function calculateImplementationReadiness() {
            let readiness = 50; // Base readiness
            
            // Add points for positive responses
            Object.values(auditData).forEach(item => {
                if (item.answer === 'yes') readiness += 8;
                else if (item.answer === 'no') readiness += 3; // Still gets points for honesty
                else if (item.answer === 'unsure') readiness += 1;
            });
            
            return Math.min(95, Math.max(30, readiness));
        }
        
        function generateActionPriorities() {
            let priorities = [];
            
            Object.entries(auditData).forEach(([key, item]) => {
                if (item.answer === 'no' || item.answer === 'unsure') {
                    priorities.push({
                        category: item.category,
                        action: getActionForQuestion(key, item.answer),
                        priority: getPriorityLevel(key)
                    });
                }
            });
            
            // Sort by priority
            priorities.sort((a, b) => {
                const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
            
            return priorities.slice(0, 5).map(item => `
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${item.priority === 'High' ? '#f5576c' : item.priority === 'Medium' ? '#f093fb' : '#667eea'};">
                    <div style="font-size: 13px; font-weight: 600; color: ${item.priority === 'High' ? '#f5576c' : item.priority === 'Medium' ? '#f093fb' : '#667eea'}; margin-bottom: 4px;">
                        ${item.priority} Priority - ${item.category}
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.9);">${item.action}</div>
                </div>
            `).join('');
        }
        
        function generateImplementationRoadmap() {
            const phases = [
                {
                    title: 'Phase 1: Foundation (Weeks 1-2)',
                    items: ['Domain & hosting setup', 'Brand identity finalization', 'Content preparation']
                },
                {
                    title: 'Phase 2: Development (Weeks 3-4)',
                    items: ['Website/platform development', 'Content integration', 'Testing & optimization']
                },
                {
                    title: 'Phase 3: Launch & Marketing (Weeks 5-6)',
                    items: ['Go-live deployment', 'Marketing campaign setup', 'Performance monitoring']
                }
            ];
            
            return phases.map(phase => `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">${phase.title}</div>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${phase.items.map(item => `<li style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 4px;">${item}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }
        
        function getActionForQuestion(questionId, answer) {
            const actions = {
                'domain': 'Secure a professional domain name that matches your brand',
                'content_photos': 'Arrange professional photography for your products/services',
                'business_info': 'Prepare comprehensive business information and service descriptions',
                'social_accounts': 'Set up and optimize social media presence on relevant platforms',
                'lead_tracking': 'Implement a CRM system for proper lead management',
                'logo_design': 'Create a professional logo and brand identity package',
                'target_audience': 'Define your ideal customer profile and target market'
            };
            return actions[questionId] || 'Address this requirement for optimal results';
        }
        
        function getPriorityLevel(questionId) {
            const priorities = {
                'domain': 'High',
                'content_photos': 'Medium',
                'business_info': 'High',
                'social_accounts': 'Medium',
                'lead_tracking': 'High',
                'logo_design': 'Medium',
                'target_audience': 'High'
            };
            return priorities[questionId] || 'Medium';
        }
        
        function getProductDisplayName(productId) {
            const names = {
                'disblay': 'Disblay Showcase',
                'topiko_basic': 'Topiko Basic',
                'topiko_pro': 'Topiko Pro',
                'marketing': 'Digital Marketing',
                'brandpreneuring': 'Brandpreneuring',
                'hebt': 'HEBT Custom'
            };
            return names[productId] || 'Professional Solution';
        }
        
        function generateCostBreakdown(recommendation) {
            const product = recommendation.primary_recommendation;
            const productId = product.product_id;
            
            // Base costs from recommendation engine
            const costs = {
                'disblay': { setup: 1499, monthly: 0, description: 'Annual showcase website' },
                'topiko_basic': { setup: 4999, monthly: 0, description: 'Professional website + domain' },
                'topiko_pro': { setup: 9999, monthly: 0, description: 'Complete business platform' },
                'marketing': { setup: 2999, monthly: 9999, description: 'Lead generation campaigns' },
                'brandpreneuring': { setup: 999, monthly: 0, description: 'Brand identity package' },
                'hebt': { setup: 300000, monthly: 0, description: 'Custom development project' }
            };
            
            const cost = costs[productId] || costs['topiko_basic'];
            const yearOneTotal = cost.setup + (cost.monthly * 12);
            
            return `
                <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Setup Investment</div>
                            <div style="font-size: 20px; font-weight: 700; color: #667eea;">‚Çπ${cost.setup.toLocaleString()}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6);">${cost.description}</div>
                        </div>
                        ${cost.monthly > 0 ? `
                        <div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Monthly Services</div>
                            <div style="font-size: 20px; font-weight: 700; color: #f093fb;">‚Çπ${cost.monthly.toLocaleString()}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6);">Ongoing marketing management</div>
                        </div>
                        ` : `
                        <div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Monthly Cost</div>
                            <div style="font-size: 20px; font-weight: 700; color: #f093fb;">‚Çπ0</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6);">One-time investment</div>
                        </div>
                        `}
                    </div>
                    ${cost.monthly > 0 ? `
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">First Year Total Investment</div>
                        <div style="font-size: 24px; font-weight: 800; color: #667eea;">‚Çπ${yearOneTotal.toLocaleString()}</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function generateProjectTimeline() {
            const phases = [
                { week: 'Week 1', tasks: ['Project kickoff', 'Requirements finalization', 'Content collection'] },
                { week: 'Week 2-3', tasks: ['Design & development', 'Content integration', 'Initial testing'] },
                { week: 'Week 4', tasks: ['Final testing', 'Client review', 'Go-live preparation'] },
                { week: 'Week 5+', tasks: ['Launch & monitoring', 'Marketing activation', 'Ongoing optimization'] }
            ];
            
            return phases.map(phase => `
                <div style="display: flex; align-items: flex-start; margin-bottom: 16px;">
                    <div style="min-width: 80px; background: rgba(102, 126, 234, 0.2); padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #667eea; margin-right: 16px;">
                        ${phase.week}
                    </div>
                    <div style="flex: 1;">
                        <ul style="margin: 0; padding-left: 16px; list-style: none;">
                            ${phase.tasks.map(task => `
                                <li style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 4px; position: relative;">
                                    <span style="position: absolute; left: -12px; color: #667eea;">‚Ä¢</span>
                                    ${task}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `).join('');
        }
        
        function generateSuccessMetrics() {
            const metrics = [
                { metric: 'Website Traffic', target: '500% increase in 3 months', icon: 'üìà' },
                { metric: 'Lead Generation', target: '25+ qualified leads monthly', icon: 'üéØ' },
                { metric: 'Brand Visibility', target: 'Top 3 Google search results', icon: 'üîç' },
                { metric: 'Customer Engagement', target: '40% higher conversion rate', icon: 'üí¨' }
            ];
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    ${metrics.map(metric => `
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 16px; margin-bottom: 4px;">${metric.icon}</div>
                            <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 4px;">${metric.metric}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.7);">${metric.target}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function identifyRiskFactors() {
            const risks = [];
            
            // Analyze audit responses for potential risks
            if (auditData.domain && auditData.domain.answer === 'no') {
                risks.push({
                    risk: 'Domain Registration Delay',
                    mitigation: 'We handle domain registration as priority #1 to avoid launch delays'
                });
            }
            
            if (auditData.content_photos && auditData.content_photos.answer === 'no') {
                risks.push({
                    risk: 'Content Quality Issues',
                    mitigation: 'Professional photography service included to ensure high-quality visuals'
                });
            }
            
            if (auditData.target_audience && auditData.target_audience.answer === 'no') {
                risks.push({
                    risk: 'Unfocused Marketing',
                    mitigation: 'Comprehensive market research and audience definition in Phase 1'
                });
            }
            
            if (risks.length === 0) return null;
            
            return risks.map(risk => `
                <div style="background: rgba(245, 87, 108, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #f5576c;">
                    <div style="font-size: 13px; font-weight: 600; color: #f5576c; margin-bottom: 4px;">${risk.risk}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8);">‚úì ${risk.mitigation}</div>
                </div>
            `).join('');
        }

        function skipAuditAndBookCall() {
            // Generate a basic consultation brief without detailed audit
            const firstName = formData.fullName.split(' ')[0];
            const recommendation = getTopikkoRecommendation(formData);
            
            alert(`Thank you ${firstName}! 
            
Based on your assessment, we recommend ${recommendation.primary_recommendation.product_name}.

Our team will call you within 2 hours to discuss:
‚Ä¢ Your ${recommendation.primary_recommendation.product_name} setup
‚Ä¢ Implementation timeline 
‚Ä¢ Pricing options
‚Ä¢ Any questions you have

We have all the information needed to help you get started!`);
            
            // In production, this would trigger:
            // - CRM lead creation with "Skip Audit" tag
            // - Immediate sales team notification
            // - Email confirmation to user
        }

        // Progressive Insights & Social Proof Functions
        function showProgressiveInsight(screenNumber) {
            const insights = {
                1: [
                    "‚úÖ Profile Created! You're ahead of 60% of businesses who haven't defined their digital goals.",
                    `Great start! ${getBusinessTypeLabel(formData.businessType)} businesses in your area average 45% digital readiness.`,
                    "Smart move! Business owners who complete assessments are 3x more likely to succeed digitally."
                ],
                2: [
                    "üìä Based on your goals, 73% of similar businesses choose website-first approach.",
                    `Excellent! ${getBusinessTypeLabel(formData.businessType)} businesses with your budget typically see 300% ROI.`,
                    "You're on track! Businesses with clear goals grow 2x faster than those without."
                ],
                3: [
                    `üéØ Your preliminary readiness score: ${calculatePreliminaryScore()}%`,
                    `Competitive insight: You're performing better than 67% of businesses in ${formData.cityLocation.split(',')[0] || 'your area'}.`,
                    "Almost there! You're about to unlock your personalized digital strategy."
                ]
            };
            
            const randomInsight = insights[screenNumber][Math.floor(Math.random() * insights[screenNumber].length)];
            const container = document.getElementById(`insightContainer${screenNumber}`);
            const text = document.getElementById(`insightText${screenNumber}`);
            
            if (container && text) {
                text.textContent = randomInsight;
                container.style.display = 'block';
            }
        }
        
        function calculatePreliminaryScore() {
            // Use realistic scoring system if available, otherwise fallback to simple calculation
            if (window.digitalReadinessScorer && formData.goals && formData.digitalStatus && formData.budget && formData.challenge) {
                const scoreData = window.digitalReadinessScorer.calculateOverallScore(formData);
                return Math.min(scoreData.totalScore, 85); // Cap at 85 for preliminary assessment
            }
            
            // Fallback realistic calculation based on answer quality
            let score = 20; // Lower base score for realism
            
            // Goals scoring - quality over quantity
            if (formData.goals && formData.goals.length > 0) {
                const advancedGoals = formData.goals.filter(g => ['app', 'automate', 'brand'].includes(g)).length;
                const basicGoals = formData.goals.length - advancedGoals;
                
                score += (advancedGoals * 12) + (basicGoals * 8);
                
                // Penalty for too many goals (lack of focus)
                if (formData.goals.length > 3) {
                    score -= 5;
                }
            }
            
            // Digital status - realistic assessment
            const statusScores = {
                'no_presence': 8,
                'basic_social': 15,
                'basic_website': 25,
                'no_results': 30
            };
            score += statusScores[formData.digitalStatus] || 0;
            
            // Budget - viability scoring
            const budgetScores = {
                'below_2k': 8,
                '2k_10k': 15,
                '10k_25k': 20,
                '25k_plus': 25
            };
            score += budgetScores[formData.budget] || 0;
            
            // Challenge awareness bonus
            const challengeScores = {
                'no_leads': 15,
                'low_sales': 18,
                'no_time': 12,
                'dont_know': 5
            };
            score += challengeScores[formData.challenge] || 0;
            
            return Math.min(score, 85); // Cap at 85 for preliminary assessment
        }
        
        function showSocialProof() {
            const messages = [
                `${getRandomNumber(8, 25)} businesses assessed today`,
                "Our plans start from ‚Çπ1,499 per year",
                "Average onboarding time is less than 24 hours",
                "Next consultation available in 1 hour",
                `${getRandomNumber(5, 15)} ${formData.businessType || 'businesses'} assessed this week`,
                "95% of clients see results within 30 days",
                `${getRandomNumber(3, 12)} ${formData.cityLocation ? formData.cityLocation.split(',')[0] : 'local'} businesses upgraded this month`,
                "Free consultation included with all plans",
                "24/7 customer support available",
                "No setup fees - start immediately",
                `Live: ${getRandomNumber(1, 4)} consultations happening now`
            ];
            
            const socialProofElement = document.getElementById('socialProof');
            if (socialProofElement) {
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                socialProofElement.textContent = randomMessage;
                socialProofElement.style.display = 'block';
                
                // Hide after 4 seconds and show new one
                setTimeout(() => {
                    socialProofElement.style.display = 'none';
                    setTimeout(() => showSocialProof(), 2000);
                }, 4000);
            }
        }
        
        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function getBusinessTypeLabel(type) {
            const types = {
                retail: 'Retail',
                services: 'Service',
                manufacturing: 'Manufacturing',
                food: 'Restaurant'
            };
            return types[type] || 'Business';
        }
        
        
        function mapProductToVisualCategory(productId) {
            const mapping = {
                'disblay': 'Showcase',
                'topiko_basic': 'Website', 
                'topiko_pro': 'Website Pro',
                'marketing': 'Marketing',
                'brandpreneuring': 'Branding',
                'hebt': 'Custom'
            };
            return mapping[productId] || 'Solution';
        }
        


        // Supabase Database Functions
        async function saveAssessmentProgress() {
            if (!supabase) return;
            
            try {
                const progressData = {
                    session_id: sessionId,
                    assessment_id: assessmentId,
                    current_screen: currentScreen,
                    total_screens: 4,
                    completion_percentage: Math.round((currentScreen / 4) * 100),
                    form_data: formData,
                    last_activity: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('assessment_progress')
                    .upsert(progressData, { 
                        onConflict: 'session_id',
                        ignoreDuplicates: false 
                    });
                
                if (error) {
                    console.error('Error saving progress:', error);
                } else {
                    console.log('‚úÖ Progress saved successfully');
                }
            } catch (error) {
                console.error('‚ùå Error in saveAssessmentProgress:', error);
            }
        }
        
        async function createAssessment() {
            if (!supabase || !formData.fullName || !formData.businessName) {
                console.log('‚ö†Ô∏è Supabase not available or missing required data, running in offline mode');
                return null;
            }
            
            try {
                // Get UTM parameters from URL
                const urlParams = new URLSearchParams(window.location.search);
                const referrer = document.referrer || '';
                const userAgent = navigator.userAgent || '';
                
                const assessmentData = {
                    full_name: formData.fullName,
                    business_name: formData.businessName,
                    business_type: formData.businessType,
                    city_location: formData.cityLocation,
                    mobile_number: formData.mobileNumber,
                    email: formData.email || null,
                    goals: formData.goals,
                    digital_status: formData.digitalStatus,
                    budget: formData.budget,
                    challenge: formData.challenge,
                    timeline: formData.timeline,
                    brand_help: formData.brandHelp,
                    team_size: formData.teamSize,
                    product_count: formData.productCount,
                    domain_status: formData.domainStatus,
                    utm_source: urlParams.get('utm_source'),
                    utm_medium: urlParams.get('utm_medium'),
                    utm_campaign: urlParams.get('utm_campaign'),
                    utm_term: urlParams.get('utm_term'),
                    utm_content: urlParams.get('utm_content'),
                    referrer: referrer,
                    user_agent: userAgent,
                    session_id: sessionId,
                    status: 'new'
                };
                
                const { data, error } = await supabase
                    .from('digital_readiness_assessments')
                    .insert(assessmentData)
                    .select()
                    .single();
                
                if (error) {
                    console.warn('‚ö†Ô∏è Database save failed, continuing in offline mode:', error.message);
                    return null;
                } else {
                    assessmentId = data.id;
                    console.log('‚úÖ Assessment created with ID:', assessmentId);
                    return data;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Database connection failed, continuing in offline mode:', error.message);
                return null;
            }
        }
        
        async function updateAssessmentResults() {
            if (!supabase || !assessmentId) return;
            
            try {
                const recommendation = getTopikkoRecommendation(formData);
                const digitalReadiness = calculateDigitalReadiness(formData);
                
                // Calculate realistic solution match using the scoring system
                const recommendedProduct = recommendation?.primary_recommendation?.product || recommendation?.product || 'Topiko';
                const solutionMatch = window.digitalReadinessScorer ? 
                    window.digitalReadinessScorer.calculateSolutionMatchScore(formData, recommendedProduct) : 
                    75; // Fallback to 75 if scorer not available
                
                const updateData = {
                    digital_readiness_score: digitalReadiness,
                    solution_match_score: solutionMatch,
                    recommended_product: recommendation.primary_recommendation?.product_id,
                    recommendation_data: recommendation,
                    last_activity: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('digital_readiness_assessments')
                    .update(updateData)
                    .eq('id', assessmentId);
                
                if (error) {
                    console.error('Error updating assessment results:', error);
                } else {
                    console.log('‚úÖ Assessment results updated successfully');
                }
            } catch (error) {
                console.error('‚ùå Error in updateAssessmentResults:', error);
            }
        }
        
        async function saveAuditData() {
            if (!supabase || !assessmentId) return;
            
            try {
                const updateData = {
                    audit_completed: true,
                    audit_data: auditData,
                    last_activity: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('digital_readiness_assessments')
                    .update(updateData)
                    .eq('id', assessmentId);
                
                if (error) {
                    console.error('Error saving audit data:', error);
                } else {
                    console.log('‚úÖ Audit data saved successfully');
                }
            } catch (error) {
                console.error('‚ùå Error in saveAuditData:', error);
            }
        }

        function downloadPlan() {
            try {
                // Generate summary for WhatsApp
                const recommendation = getTopikkoRecommendation(formData);
                const mobileEl = document.getElementById('mobileNumber');
                const mobile = mobileEl ? mobileEl.value.trim() : formData.mobileNumber;
                
                if (!mobile) {
                    alert('‚ùå Mobile number not found. Please complete the assessment first.');
                    return;
                }
                
                const summary = `üöÄ *Digital Readiness Assessment Results*

üìä *Overall Score:* ${recommendation.totalScore}%
üí° *Recommended Solution:* ${recommendation.primaryRecommendation.name}

üìà *Key Insights:*
‚Ä¢ Marketing: ${recommendation.categoryScores.marketing}%
‚Ä¢ Website: ${recommendation.categoryScores.website}%
‚Ä¢ Branding: ${recommendation.categoryScores.branding}%

üéØ *Next Steps:*
${recommendation.primaryRecommendation.description}

üí∞ *Investment Range:* ${recommendation.primaryRecommendation.price}
‚è±Ô∏è *Setup Time:* ${recommendation.primaryRecommendation.timeline}

üìû *Ready to get started?*
Contact us: +91-885-886-8889

*Topiko - Digital Transformation Made Simple*
www.topikopartner.com`;

                // Create WhatsApp URL with country code
                const mobileWithCode = mobile.startsWith('91') ? mobile : `91${mobile}`;
                const whatsappUrl = `https://wa.me/${mobileWithCode}?text=${encodeURIComponent(summary)}`;
                
                console.log('Opening WhatsApp URL:', whatsappUrl);
                
                // Open WhatsApp
                window.open(whatsappUrl, '_blank');
                
                // Show confirmation
                setTimeout(() => {
                    alert('üì± WhatsApp opened with your assessment summary!\n\nüìß You will also receive a detailed plan via email within 30 minutes.\n\nüìû Our team will call to discuss implementation.');
                }, 1000);
            } catch (error) {
                console.error('Download Plan Error:', error);
                alert('‚ùå Unable to open WhatsApp. Please ensure you have WhatsApp installed or contact us directly at +91-885-886-8889');
            }
        }

        // Schedule Call Functions
        function showScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'flex';
            generateTimeSlots();
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
        }

        function generateTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            const now = new Date();
            const slots = [];
            
            // Start from 2 hours from now
            let startTime = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            
            // Round to next even hour
            startTime.setMinutes(0, 0, 0);
            if (startTime.getHours() % 2 !== 0) {
                startTime.setHours(startTime.getHours() + 1);
            }
            
            // Generate slots until we have 6 valid business hour slots
            let currentTime = new Date(startTime);
            let attempts = 0;
            
            while (slots.length < 6 && attempts < 20) { // Safety limit
                const hour = currentTime.getHours();
                
                // Only include business hours (10 AM to 6 PM)
                if (hour >= 10 && hour <= 18) {
                    const timeString = currentTime.toLocaleTimeString('en-IN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'Asia/Kolkata'
                    });
                    const dateString = currentTime.toLocaleDateString('en-IN', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        timeZone: 'Asia/Kolkata'
                    });
                    
                    slots.push({
                        time: new Date(currentTime), // Create new Date object
                        display: `${dateString} ${timeString}`
                    });
                }
                
                // Move to next 2-hour slot
                currentTime.setHours(currentTime.getHours() + 2);
                
                // If we go past business hours, move to next day at 10 AM
                if (currentTime.getHours() > 18) {
                    currentTime.setDate(currentTime.getDate() + 1);
                    currentTime.setHours(10, 0, 0, 0);
                }
                
                attempts++;
            }
            
            // Display slots
            timeSlotsContainer.innerHTML = slots.map((slot, index) => 
                `<div class="time-slot" onclick="selectTimeSlot(${index}, '${slot.display}', '${slot.time.toISOString()}')">${slot.display}</div>`
            ).join('');
        }

        function selectTimeSlot(index, displayTime, isoTime) {
            // Remove previous selection
            document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
            
            // Select current slot
            document.querySelectorAll('.time-slot')[index].classList.add('selected');
            
            // Confirm selection
            setTimeout(() => {
                if (confirm(`Confirm your call slot:\n${displayTime}\n\nOur expert will call you at this time?`)) {
                    alert(`‚úÖ Call scheduled for ${displayTime}\n\nYou will receive a confirmation SMS shortly. Our digital transformation expert will call you at the scheduled time.`);
                    closeScheduleModal();
                }
            }, 200);
        }

        // Desktop enhancements - Force Deploy v2
        function initializeDesktopEnhancements() {
            if (window.innerWidth >= 768) {
                // Show desktop elements
                // Keep mobile view on desktop - no desktop-specific elements
                document.querySelector('.desktop-progress').style.display = 'none';
                document.querySelector('.desktop-ambient-left').style.display = 'none';
                document.querySelector('.desktop-ambient-right').style.display = 'none';
                document.querySelector('.desktop-trust-badges').style.display = 'none';
                
                // Initialize live counter animation
                animateLiveCounter();
                
                // Create floating particles
                createFloatingParticles();
                
                // Update desktop progress
                updateDesktopProgress();
            }
        }

        function animateLiveCounter() {
            const counter = document.getElementById('liveUserCount');
            if (!counter) return;
            
            setInterval(() => {
                const current = parseInt(counter.textContent.replace(',', ''));
                const newCount = current + Math.floor(Math.random() * 3);
                counter.textContent = newCount.toLocaleString();
            }, 15000); // Update every 15 seconds
        }

        function createFloatingParticles() {
            const particleCount = 12;
            const body = document.body;
            
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'desktop-particle';
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.animationDelay = Math.random() * 8 + 's';
                    body.appendChild(particle);
                    
                    // Remove particle after animation
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 8000);
                }, i * 2000); // Stagger particle creation
            }
        }

        function updateDesktopProgress() {
            const progressFill = document.getElementById('desktopProgressFill');
            const progressText = document.getElementById('desktopProgressText');
            
            if (!progressFill || !progressText) return;
            
            // Calculate progress based on current screen
            const totalScreens = 6; // Including results and plan screens
            const progressPercentage = Math.round((currentScreen / totalScreens) * 100);
            
            progressFill.style.width = progressPercentage + '%';
            progressText.textContent = progressPercentage + '% Complete';
        }

        // Enhanced screen navigation for desktop - DISABLED
        // const originalShowScreen = showScreen;
        // showScreen = function(screenId) {
        //     originalShowScreen(screenId);
        //     if (window.innerWidth >= 768) {
        //         updateDesktopProgress();
        //     }
        // };

        // Function to completely remove any recommendation preview elements
        function removeRecommendationPreviews() {
            // Hide any elements that might contain recommendation previews
            const previewElements = [
                'recommendation-preview',
                'rec-preview',
                'preview-container',
                'progress-preview',
                'recommendation-cards',
                'rec-cards',
                'preview-cards'
            ];
            
            previewElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none !important';
                    element.remove();
                }
            });
            
            // Also check for class names
            const previewClassElements = document.querySelectorAll('.recommendation-preview, .rec-preview, .preview-container, .progress-preview, .recommendation-cards, .rec-cards, .preview-cards');
            previewClassElements.forEach(element => {
                element.style.display = 'none !important';
                element.remove();
            });
            
            // Remove any dynamically generated preview content
            const allDivs = document.querySelectorAll('div');
            allDivs.forEach(div => {
                if (div.textContent && div.textContent.includes('Optimizing') && div.textContent.includes('goals')) {
                    div.style.display = 'none !important';
                    div.remove();
                }
            });
        }

        // Initialize desktop enhancements on load and resize - DISABLED
        // window.addEventListener('load', initializeDesktopEnhancements);
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                // initializeDesktopEnhancements(); // Disabled to show mobile view
            } else {
                // Hide desktop elements on mobile
                document.querySelector('.desktop-progress').style.display = 'none';
                document.querySelector('.desktop-ambient-left').style.display = 'none';
                document.querySelector('.desktop-ambient-right').style.display = 'none';
                document.querySelector('.desktop-trust-badges').style.display = 'none';
            }
        });

        // Remove recommendation previews immediately and on page load
        removeRecommendationPreviews();
        document.addEventListener('DOMContentLoaded', removeRecommendationPreviews);
        window.addEventListener('load', removeRecommendationPreviews);
        
        // Run cleanup every 500ms to catch any dynamically generated content
        setInterval(removeRecommendationPreviews, 500);

        // Continuous particle generation for desktop
        if (window.innerWidth >= 768) {
            setInterval(createFloatingParticles, 20000); // Create new batch every 20 seconds
        }
    </script>
    </div> <!-- Close mobile-container -->
    </div> <!-- Close desktop-wrapper -->
</body>
</html>